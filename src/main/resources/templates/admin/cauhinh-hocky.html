<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cấu hình Học kỳ & Năm học - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        /* Thêm vào phần <style> */
        .semester-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .semester-timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #007bff, #28a745);
        }

        .semester-timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
        }

        .semester-timeline-item.current {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            border-left-color: #28a745;
        }

        .semester-timeline-item.đang-diễn-ra {
            border-left-color: #28a745;
        }

        .semester-timeline-item.chưa-bắt-đầu {
            border-left-color: #ffc107;
        }

        .semester-timeline-item.đã-kết-thúc {
            border-left-color: #6c757d;
        }

        .timeline-marker {
            position: absolute;
            left: -2.25rem;
            top: 1rem;
            width: 2rem;
            height: 2rem;
            background: white;
            border: 3px solid #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .semester-timeline-item.current .timeline-marker {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .order-number {
            font-size: 0.75rem;
            font-weight: bold;
        }

        .sortable-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .sortable-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: move;
            transition: all 0.2s ease;
        }

        .sortable-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sortable-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .timeline-container {
            position: relative;
            margin: 2rem 0;
        }

        .timeline {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 4px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -2px;
            border-radius: 2px;
        }

        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background: inherit;
            width: 50%;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            background: white;
            border: 4px solid #667eea;
            top: 20px;
            border-radius: 50%;
            z-index: 1;
        }

        .timeline-item:nth-child(even) {
            left: 50%;
        }

        .timeline-item:nth-child(even)::after {
            left: -10px;
        }

        .timeline-item.current::after {
            background: #28a745;
            border-color: #28a745;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3);
        }

        .timeline-content {
            padding: 1.5rem;
            background: white;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .timeline-item.current .timeline-content {
            border-left-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        }

        .progress-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .progress-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: conic-gradient(#28a745 0deg, #28a745 var(--progress-angle), #e9ecef var(--progress-angle));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .progress-text {
            position: relative;
            z-index: 1;
            font-weight: bold;
            color: #495057;
        }

        .semester-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .semester-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .semester-card.ongoing {
            border-left-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        }

        .semester-card.upcoming {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
        }

        .semester-card.finished {
            border-left-color: #6c757d;
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-ongoing {
            background: #d4edda;
            color: #155724;
        }

        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }

        .status-finished {
            background: #f8f9fa;
            color: #6c757d;
        }

        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
            margin: 0.25rem;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
            color: white;
        }

        @media screen and (max-width: 600px) {
            .timeline::after {
                left: 31px;
            }
            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }
            .timeline-item:nth-child(even) {
                left: 0%;
            }
            .timeline-item::after {
                left: 21px;
            }
            .timeline-item:nth-child(even)::after {
                left: 21px;
            }
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
        }

        .deleted-item {
            transition: all 0.3s ease;
        }

        .deleted-item:hover {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
        }

        .dropdown-menu .dropdown-item {
            padding: 0.5rem 1rem;
        }

        .dropdown-menu .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-menu .dropdown-item.text-danger:hover {
            background-color: #f8d7da;
            color: #721c24 !important;
        }

        /* Badge styling cho trạng thái */
        .badge.bg-deleted {
            background-color: #6c757d !important;
        }

        .badge.bg-active {
            background-color: #198754 !important;
        }

        .badge.bg-current {
            background-color: #fd7e14 !important;
        }

        /* Animation cho loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }


        .main-content{
            padding-left: 30px;
            padding-top: 20px;
        }


    </style>
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Cấu hình Học kỳ & Năm học</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openCreateAcademicYearModal()">
                        <i class="fas fa-plus me-2"></i>Tạo năm học
                    </button>
                    <button class="btn btn-success" onclick="openCreateSemesterModal()">
                        <i class="fas fa-plus me-2"></i>Tạo học kỳ
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Current Status Cards -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="progress-card">
                        <h5 class="mb-3"><i class="fas fa-calendar-alt text-primary me-2"></i>Năm học hiện tại</h5>
                        <div id="currentAcademicYearInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Đang tải...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="progress-card">
                        <h5 class="mb-3"><i class="fas fa-clock text-success me-2"></i>Học kỳ hiện tại</h5>
                        <div id="currentSemesterInfo">
                            <div class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Đang tải...</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="quick-actions">
                        <h5 class="mb-3"><i class="fas fa-bolt text-warning me-2"></i>Thao tác nhanh</h5>
                        <div class="d-flex flex-wrap">
                            <button class="action-button" onclick="setNextSemesterAsCurrent()">
                                <i class="fas fa-forward me-2"></i>Chuyển học kỳ tiếp theo
                            </button>
                            <button class="action-button" onclick="setNextAcademicYearAsCurrent()">
                                <i class="fas fa-fast-forward me-2"></i>Chuyển năm học tiếp theo
                            </button>
                            <button class="action-button" onclick="generateNextAcademicYear()">
                                <i class="fas fa-magic me-2"></i>Tạo năm học kế tiếp
                            </button>
                            <button class="action-button" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-2"></i>Làm mới dữ liệu
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button" role="tab">
                        <i class="fas fa-timeline me-2"></i>Timeline
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="academic-years-tab" data-bs-toggle="tab" data-bs-target="#academic-years" type="button" role="tab">
                        <i class="fas fa-calendar me-2"></i>Năm học
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="semesters-tab" data-bs-toggle="tab" data-bs-target="#semesters" type="button" role="tab">
                        <i class="fas fa-clock me-2"></i>Học kỳ
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="configTabsContent">
                <!-- Timeline Tab -->
                <div class="tab-pane fade show active" id="timeline" role="tabpanel">
                    <div class="timeline-container">
                        <h5 class="text-center mb-4">Timeline Năm học & Học kỳ</h5>
                        <div id="timelineContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Đang tải timeline...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academic Years Tab -->
                <div class="tab-pane fade" id="academic-years" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Danh sách Năm học</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="filterAcademicYears('all')">Tất cả</button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="filterAcademicYears('ongoing')">Đang diễn ra</button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="filterAcademicYears('upcoming')">Sắp tới</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="filterAcademicYears('finished')">Đã kết thúc</button>
                        </div>
                    </div>
                    <div id="academicYearsList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Đang tải danh sách năm học...</p>
                        </div>
                    </div>
                </div>

                <!-- Semesters Tab -->
                <div class="tab-pane fade" id="semesters" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Danh sách Học kỳ</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="filterSemesters('all')">Tất cả</button>
                            <button class="btn btn-outline-success btn-sm me-2" onclick="filterSemesters('ongoing')">Đang diễn ra</button>
                            <button class="btn btn-outline-warning btn-sm me-2" onclick="filterSemesters('upcoming')">Sắp tới</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="filterSemesters('finished')">Đã kết thúc</button>
                        </div>
                    </div>
                    <div id="semestersList">
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Đang tải danh sách học kỳ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Tạo/Sửa Năm học -->
<div class="modal fade" id="academicYearModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="academicYearModalTitle">Tạo năm học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="academicYearForm">
                    <input type="hidden" id="academicYearId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maNamHoc" class="form-label">Mã năm học <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maNamHoc" placeholder="2024-2025" required>
                                <small class="form-text text-muted">Ví dụ: 2024-2025</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tenNamHoc" class="form-label">Tên năm học <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenNamHoc" placeholder="Năm học 2024-2025" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayBatDauNamHoc" class="form-label">Ngày bắt đầu <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayBatDauNamHoc" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayKetThucNamHoc" class="form-label">Ngày kết thúc <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayKetThucNamHoc" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moTaNamHoc" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="moTaNamHoc" rows="3" placeholder="Mô tả về năm học..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveNamHoc" checked>
                                <label class="form-check-label" for="isActiveNamHoc">Kích hoạt</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isCurrentNamHoc">
                                <label class="form-check-label" for="isCurrentNamHoc">Đặt làm hiện tại</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="createWithSemesters()">
                    <i class="fas fa-magic me-2"></i>Tạo kèm học kỳ
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAcademicYear()">
                    <span class="btn-text">Lưu</span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Tạo/Sửa Học kỳ -->
<div class="modal fade" id="semesterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="semesterModalTitle">Tạo học kỳ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="semesterForm">
                    <input type="hidden" id="semesterId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maHocKy" class="form-label">Mã học kỳ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maHocKy" placeholder="2024-2025_HK1" required>
                                <small class="form-text text-muted">Ví dụ: 2024-2025_HK1</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tenHocKy" class="form-label">Tên học kỳ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="tenHocKy" placeholder="Học kỳ 1 - Năm học 2024-2025" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayBatDauHocKy" class="form-label">Ngày bắt đầu <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayBatDauHocKy" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ngayKetThucHocKy" class="form-label">Ngày kết thúc <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="ngayKetThucHocKy" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="moTaHocKy" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="moTaHocKy" rows="3" placeholder="Mô tả về học kỳ..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActiveHocKy" checked>
                                <label class="form-check-label" for="isActiveHocKy">Kích hoạt</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isCurrentHocKy">
                                <label class="form-check-label" for="isCurrentHocKy">Đặt làm hiện tại</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveSemester()">
                    <span class="btn-text">Lưu</span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>

<script>
    // Constants
    const API_BASE = '/api';

    // Global Data
    let academicYears = [];
    let semesters = [];
    let currentFilter = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        setupEventListeners();
    });

    async function initializePage() {
        console.log('🚀 Initializing Academic Configuration page...');

        try {
            await Promise.all([
                loadAcademicYears(),
                loadSemesters(),
                loadCurrentStatus()
            ]);

            renderTimeline();
            renderAcademicYearsList();
            renderSemestersList();

            console.log('✅ Page initialized successfully');
        } catch (error) {
            console.error('❌ Error initializing page:', error);
            showNotification('Lỗi khi tải dữ liệu: ' + error.message, 'error');
        }
    }

    // Thêm vào function setupEventListeners()
    function setupEventListeners() {
        // Date validation
        document.getElementById('ngayBatDauNamHoc').addEventListener('change', validateAcademicYearDates);
        document.getElementById('ngayKetThucNamHoc').addEventListener('change', validateAcademicYearDates);
        document.getElementById('ngayBatDauHocKy').addEventListener('change', validateSemesterDates);
        document.getElementById('ngayKetThucHocKy').addEventListener('change', validateSemesterDates);

        // Sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);

        // Auto-sync progress when semester data changes
        document.addEventListener('semesterUpdated', async (event) => {
            if (event.detail.maNamHoc) {
                await updateAcademicYearStatus(event.detail.maNamHoc);
                await loadCurrentStatus();
            }
        });
    }

    // Trigger custom event khi có thay đổi học kỳ
    function triggerSemesterUpdated(maNamHoc) {
        const event = new CustomEvent('semesterUpdated', {
            detail: { maNamHoc: maNamHoc }
        });
        document.dispatchEvent(event);
    }

    // Data Loading Functions
    async function loadAcademicYears() {
        try {
            const response = await fetch(`${API_BASE}/namhoc/all`);
            if (!response.ok) throw new Error('Failed to load academic years');

            academicYears = await response.json();
            console.log('✅ Academic years loaded:', academicYears.length);
        } catch (error) {
            console.error('❌ Error loading academic years:', error);
            academicYears = [];
        }
    }

    async function loadSemesters() {
        try {
            // Lấy tất cả học kỳ thông qua quan hệ với năm học
            const response = await fetch(`${API_BASE}/hockynamhoc`);
            if (!response.ok) throw new Error('Failed to load semester relationships');

            const semesterRelations = await response.json();

            // Lấy thông tin chi tiết học kỳ
            const semesterPromises = semesterRelations.map(async (rel) => {
                try {
                    const hocKyResponse = await fetch(`${API_BASE}/hocky/${rel.maHocKy}`);
                    if (hocKyResponse.ok) {
                        const hocKy = await hocKyResponse.json();
                        return {
                            ...hocKy,
                            maNamHoc: rel.maNamHoc,
                            tenNamHoc: rel.tenNamHoc,
                            thuTu: rel.thuTu
                        };
                    }
                } catch (error) {
                    console.warn(`Could not load semester ${rel.maHocKy}:`, error);
                }
                return null;
            });

            const semesterResults = await Promise.all(semesterPromises);
            semesters = semesterResults.filter(s => s !== null);

            console.log('✅ Semesters loaded:', semesters.length);
        } catch (error) {
            console.error('❌ Error loading semesters:', error);
            semesters = [];
        }
    }

    async function loadCurrentStatus() {
        try {
            // Load current academic year
            const currentYearResponse = await fetch(`${API_BASE}/namhoc/current`);
            const currentSemesterResponse = await fetch(`${API_BASE}/hocky/current`);

            if (currentYearResponse.ok) {
                const currentYear = await currentYearResponse.json();
                renderCurrentAcademicYear(currentYear);
            } else {
                renderCurrentAcademicYear(null);
            }

            if (currentSemesterResponse.ok) {
                const currentSemester = await currentSemesterResponse.json();
                renderCurrentSemester(currentSemester);
            } else {
                renderCurrentSemester(null);
            }
        } catch (error) {
            console.error('❌ Error loading current status:', error);
            renderCurrentAcademicYear(null);
            renderCurrentSemester(null);
        }
    }

    function renderCurrentAcademicYear(academicYear) {
        const container = document.getElementById('currentAcademicYearInfo');

        if (!academicYear) {
            container.innerHTML = `
           <div class="text-center py-4">
               <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
               <h6>Chưa có năm học hiện tại</h6>
               <p class="text-muted mb-3">Vui lòng thiết lập năm học hiện tại</p>
               <button class="btn btn-primary btn-sm" onclick="openCreateAcademicYearModal()">
                   <i class="fas fa-plus me-2"></i>Tạo năm học
               </button>
           </div>
       `;
            return;
        }

        const progressAngle = academicYear.tiLePhanTram ? (academicYear.tiLePhanTram / 100) * 360 : 0;

        container.innerHTML = `
       <div class="row align-items-center">
           <div class="col-md-4 text-center">
               <div class="progress-circle" style="--progress-angle: ${progressAngle}deg;">
                   <div class="progress-text">${Math.round(academicYear.tiLePhanTram || 0)}%</div>
               </div>
           </div>
           <div class="col-md-8">
               <h6 class="text-primary">${academicYear.tenNamHoc}</h6>
               <p class="mb-2"><strong>Mã:</strong> ${academicYear.maNamHoc}</p>
               <p class="mb-2"><strong>Thời gian:</strong> ${formatDate(academicYear.ngayBatDau)} - ${formatDate(academicYear.ngayKetThuc)}</p>
               <p class="mb-2"><strong>Số học kỳ:</strong> ${academicYear.soHocKy || 0}</p>
               <p class="mb-2"><strong>Trạng thái:</strong> <span class="status-badge status-${getStatusClass(academicYear.trangThai)}">${academicYear.trangThai}</span></p>
               ${academicYear.soNgayConLai !== null ? `<p class="mb-2"><strong>Còn lại:</strong> ${academicYear.soNgayConLai} ngày</p>` : ''}

               <!-- Thông tin học kỳ hiện tại -->
               <div class="mt-3">
                   <button class="btn btn-sm btn-outline-info" onclick="showCurrentSemesterInfo('${academicYear.maNamHoc}')">
                       <i class="fas fa-list me-1"></i>Xem học kỳ (${academicYear.soHocKy || 0})
                   </button>
                   <button class="btn btn-sm btn-outline-success" onclick="syncAcademicYearProgress('${academicYear.maNamHoc}')">
                       <i class="fas fa-sync me-1"></i>Đồng bộ tiến độ
                   </button>
               </div>
           </div>
       </div>
   `;
    }
    /**
     * Hiển thị thông tin học kỳ của năm học hiện tại
     */
    async function showCurrentSemesterInfo(maNamHoc) {
        try {
            showLoading('Đang tải thông tin học kỳ...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/detailed-semesters`);
            if (!response.ok) throw new Error('Failed to load semester info');

            const semesterData = await response.json();

            const modalContent = `
            <div class="modal fade" id="currentSemesterInfoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-calendar-week me-2"></i>
                                Học kỳ của năm học ${maNamHoc}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <h5>${semesterData.total}</h5>
                                            <small>Tổng học kỳ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center">
                                            <h5>${semesterData.ongoing}</h5>
                                            <small>Đang diễn ra</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center">
                                            <h5>${Math.round(semesterData.averageProgress || 0)}%</h5>
                                            <small>Tiến độ TB</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="semester-timeline">
                                ${semesterData.semesters.map((sem, index) => `
                                    <div class="semester-timeline-item ${sem.isCurrent ? 'current' : ''} ${sem.trangThai.toLowerCase().replace(' ', '-')}">
                                        <div class="timeline-marker">
                                            <span class="order-number">${sem.thuTu || index + 1}</span>
                                        </div>
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h6 class="mb-1">${sem.tenHocKy}</h6>
                                                    <small class="text-muted">${formatDate(sem.ngayBatDau)} - ${formatDate(sem.ngayKetThuc)}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-${getStatusBadgeColor(sem.trangThai)}">${sem.trangThai}</span>
                                                    ${sem.isCurrent ? '<br><span class="badge bg-warning mt-1">Hiện tại</span>' : ''}
                                                </div>
                                            </div>
                                            <div class="progress mt-2" style="height: 6px;">
                                                <div class="progress-bar" style="width: ${sem.tiLePhanTram || 0}%"></div>
                                            </div>
                                            <small class="text-muted">${Math.round(sem.tiLePhanTram || 0)}% hoàn thành</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary" onclick="manageSemesterOrder('${maNamHoc}')">
                                <i class="fas fa-sort me-2"></i>Sắp xếp thứ tự
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal
            const existingModal = document.getElementById('currentSemesterInfoModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('currentSemesterInfoModal'));
            modal.show();

            // Cleanup on close
            document.getElementById('currentSemesterInfoModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });

        } catch (error) {
            console.error('Error showing current semester info:', error);
            showNotification('Lỗi khi tải thông tin học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Đồng bộ tiến độ năm học từ học kỳ
     */
    async function syncAcademicYearProgress(maNamHoc) {
        try {
            showLoading('Đang đồng bộ tiến độ...');

            await updateAcademicYearStatus(maNamHoc);
            await loadCurrentStatus();

            showNotification('Đã đồng bộ tiến độ năm học thành công!', 'success');

        } catch (error) {
            console.error('Error syncing progress:', error);
            showNotification('Lỗi khi đồng bộ tiến độ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Quản lý thứ tự học kỳ trong năm học
     */
    async function manageSemesterOrder(maNamHoc) {
        try {
            showLoading('Đang tải danh sách học kỳ...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters-order`);
            if (!response.ok) throw new Error('Failed to load semesters');

            const semesters = await response.json();

            const modalContent = `
            <div class="modal fade" id="semesterOrderModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-sort me-2"></i>Sắp xếp thứ tự học kỳ
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="sortableSemesters" class="sortable-list">
                                ${semesters.map((sem, index) => `
                                    <div class="sortable-item" data-ma-hoc-ky="${sem.maHocKy}" data-thu-tu="${sem.thuTu || index + 1}">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-grip-vertical text-muted me-3"></i>
                                            <div class="flex-grow-1">
                                                <strong>${sem.tenHocKy}</strong>
                                                <br><small class="text-muted">${formatDate(sem.ngayBatDau)} - ${formatDate(sem.ngayKetThuc)}</small>
                                            </div>
                                            <span class="badge bg-primary">Thứ tự: ${sem.thuTu || index + 1}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary" onclick="saveSemesterOrder('${maNamHoc}')">
                                <i class="fas fa-save me-2"></i>Lưu thứ tự
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Remove existing modal
            const existingModal = document.getElementById('semesterOrderModal');
            if (existingModal) existingModal.remove();

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);

            // Initialize sortable
            initializeSortable();

            const modal = new bootstrap.Modal(document.getElementById('semesterOrderModal'));
            modal.show();

        } catch (error) {
            console.error('Error managing semester order:', error);
            showNotification('Lỗi khi tải danh sách học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Lưu thứ tự học kỳ mới
     */
    async function saveSemesterOrder(maNamHoc) {
        try {
            const sortableItems = document.querySelectorAll('#sortableSemesters .sortable-item');
            const orderData = Array.from(sortableItems).map((item, index) => ({
                maHocKy: item.dataset.maHocKy,
                thuTu: index + 1
            }));

            showLoading('Đang lưu thứ tự...');

            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/update-order`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orders: orderData })
            });

            if (response.ok) {
                showNotification('Đã cập nhật thứ tự học kỳ thành công!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('semesterOrderModal')).hide();
                await initializePage();
            } else {
                throw new Error('Failed to update order');
            }

        } catch (error) {
            console.error('Error saving semester order:', error);
            showNotification('Lỗi khi lưu thứ tự: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    function renderCurrentSemester(semester) {
        const container = document.getElementById('currentSemesterInfo');

        if (!semester) {
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h6>Chưa có học kỳ hiện tại</h6>
                <p class="text-muted mb-3">Vui lòng thiết lập học kỳ hiện tại</p>
                <button class="btn btn-success btn-sm" onclick="openCreateSemesterModal()">
                    <i class="fas fa-plus me-2"></i>Tạo học kỳ
                </button>
            </div>
        `;
            return;
        }

        const progressAngle = semester.tiLePhanTram ? (semester.tiLePhanTram / 100) * 360 : 0;

        container.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-4 text-center">
                <div class="progress-circle" style="--progress-angle: ${progressAngle}deg;">
                    <div class="progress-text">${Math.round(semester.tiLePhanTram || 0)}%</div>
                </div>
            </div>
            <div class="col-md-8">
                <h6 class="text-success">${semester.tenHocKy}</h6>
                <p class="mb-2"><strong>Mã:</strong> ${semester.maHocKy}</p>
                <p class="mb-2"><strong>Năm học:</strong> ${semester.tenNamHoc || 'N/A'}</p>
                ${semester.thuTu ? `<p class="mb-2"><strong>Thứ tự:</strong> ${semester.thuTu}</p>` : ''}
                <p class="mb-2"><strong>Thời gian:</strong> ${formatDate(semester.ngayBatDau)} - ${formatDate(semester.ngayKetThuc)}</p>
                <p class="mb-2"><strong>Trạng thái:</strong> <span class="status-badge status-${getStatusClass(semester.trangThai)}">${semester.trangThai}</span></p>
                ${semester.soNgayConLai !== null ? `<p class="mb-0"><strong>Còn lại:</strong> ${semester.soNgayConLai} ngày</p>` : ''}
            </div>
        </div>
    `;
    }

    function renderTimeline() {
        const container = document.getElementById('timelineContainer');

        // Combine and sort all items by date
        const allItems = [
            ...academicYears.map(item => ({...item, type: 'year'})),
            ...semesters.map(item => ({...item, type: 'semester'}))
        ].sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

        if (allItems.length === 0) {
            container.innerHTML = `
               <div class="text-center py-5">
                   <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                   <h5>Chưa có dữ liệu</h5>
                   <p class="text-muted">Vui lòng tạo năm học và học kỳ</p>
               </div>
           `;
            return;
        }

        container.innerHTML = allItems.map((item, index) => {
            const isCurrent = item.isCurrent;
            const icon = item.type === 'year' ? 'calendar' : 'clock';
            const color = item.type === 'year' ? 'primary' : 'success';

            return `
               <div class="timeline-item ${isCurrent ? 'current' : ''}">
                   <div class="timeline-content">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                           <h6 class="text-${color}">
                               <i class="fas fa-${icon} me-2"></i>
                               ${item.type === 'year' ? item.tenNamHoc : item.tenHocKy}
                               ${isCurrent ? '<span class="badge bg-success ms-2">Hiện tại</span>' : ''}
                           </h6>
                           <span class="status-badge status-${getStatusClass(item.trangThai)}">${item.trangThai}</span>
                       </div>
                       <p class="mb-2">
                           <i class="fas fa-calendar-alt me-2 text-muted"></i>
                           ${formatDate(item.ngayBatDau)} - ${formatDate(item.ngayKetThuc)}
                       </p>
                       ${item.moTa ? `<p class="mb-2 text-muted">${item.moTa}</p>` : ''}
                       <div class="progress mb-2" style="height: 6px;">
                           <div class="progress-bar bg-${color}" style="width: ${item.tiLePhanTram || 0}%"></div>
                       </div>
                       <small class="text-muted">Tiến độ: ${Math.round(item.tiLePhanTram || 0)}%</small>

                       <div class="mt-3">
                           <button class="btn btn-outline-${color} btn-sm me-2" onclick="edit${item.type === 'year' ? 'AcademicYear' : 'Semester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                               <i class="fas fa-edit"></i> Sửa
                           </button>
                           ${!isCurrent ? `
                               <button class="btn btn-outline-warning btn-sm me-2" onclick="setAs${item.type === 'year' ? 'CurrentAcademicYear' : 'CurrentSemester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                                   <i class="fas fa-star"></i> Đặt hiện tại
                               </button>
                           ` : ''}
                           <button class="btn btn-outline-danger btn-sm" onclick="delete${item.type === 'year' ? 'AcademicYear' : 'Semester'}('${item.type === 'year' ? item.maNamHoc : item.maHocKy}')">
                               <i class="fas fa-trash"></i> Xóa
                           </button>
                       </div>
                   </div>
               </div>
           `;
        }).join('');
    }

    function renderAcademicYearsList() {
        const container = document.getElementById('academicYearsList');
        let filteredYears = academicYears;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredYears = academicYears.filter(year => {
                switch(currentFilter) {
                    case 'ongoing': return year.trangThai === 'Đang diễn ra';
                    case 'upcoming': return year.trangThai === 'Chưa bắt đầu';
                    case 'finished': return year.trangThai === 'Đã kết thúc';
                    default: return true;
                }
            });
        }

        if (filteredYears.length === 0) {
            container.innerHTML = `
               <div class="text-center py-5">
                   <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                   <h5>Không có năm học nào</h5>
                   <p class="text-muted">Vui lòng tạo năm học mới</p>
               </div>
           `;
            return;
        }

        container.innerHTML = filteredYears.map(year => `
           <div class="semester-card ${getStatusClass(year.trangThai)}">
               <div class="row align-items-center">
                   <div class="col-md-8">
                       <div class="d-flex justify-content-between align-items-start mb-2">
                           <h6 class="text-primary">
                               ${year.tenNamHoc}
                               ${year.isCurrent ? '<span class="badge bg-success ms-2">Hiện tại</span>' : ''}
                           </h6>
                           <span class="status-badge status-${getStatusClass(year.trangThai)}">${year.trangThai}</span>
                       </div>
                       <p class="mb-1"><strong>Mã:</strong> ${year.maNamHoc}</p>
                       <p class="mb-1"><strong>Thời gian:</strong> ${formatDate(year.ngayBatDau)} - ${formatDate(year.ngayKetThuc)}</p>
                       <p class="mb-1"><strong>Số học kỳ:</strong> ${year.soHocKy || 0}</p>
                       ${year.moTa ? `<p class="mb-2 text-muted">${year.moTa}</p>` : ''}
                   </div>
                   <div class="col-md-4 text-end">
                       <div class="progress mb-2" style="height: 8px;">
                           <div class="progress-bar" style="width: ${year.tiLePhanTram || 0}%"></div>
                       </div>
                       <small class="text-muted d-block mb-3">Tiến độ: ${Math.round(year.tiLePhanTram || 0)}%</small>

                       <div class="btn-group-vertical btn-group-sm">
                           <button class="btn btn-outline-primary" onclick="editAcademicYear('${year.maNamHoc}')">
                               <i class="fas fa-edit"></i> Sửa
                           </button>
                           ${!year.isCurrent ? `
                               <button class="btn btn-outline-warning" onclick="setAsCurrentAcademicYear('${year.maNamHoc}')">
                                   <i class="fas fa-star"></i> Đặt hiện tại
                               </button>
                           ` : ''}
                           <button class="btn btn-outline-danger" onclick="deleteAcademicYear('${year.maNamHoc}')">
                               <i class="fas fa-trash"></i> Xóa
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       `).join('');
    }

    function renderSemestersList() {
        const container = document.getElementById('semestersList');
        let filteredSemesters = semesters;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredSemesters = semesters.filter(semester => {
                switch(currentFilter) {
                    case 'ongoing': return semester.trangThai === 'Đang diễn ra';
                    case 'upcoming': return semester.trangThai === 'Chưa bắt đầu';
                    case 'finished': return semester.trangThai === 'Đã kết thúc';
                    default: return true;
                }
            });
        }

        if (filteredSemesters.length === 0) {
            container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                <h5>Không có học kỳ nào</h5>
                <p class="text-muted">Vui lòng tạo học kỳ mới</p>
            </div>
        `;
            return;
        }

        container.innerHTML = filteredSemesters.map(semester => `
        <div class="semester-card ${getStatusClass(semester.trangThai)}">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-success">
                            ${semester.tenHocKy}
                            ${semester.isCurrent ? '<span class="badge bg-success ms-2">Hiện tại</span>' : ''}
                            ${semester.thuTu ? '<span class="badge bg-info ms-2">Thứ tự ' + semester.thuTu + '</span>' : ''}
                        </h6>
                        <span class="status-badge status-${getStatusClass(semester.trangThai)}">${semester.trangThai}</span>
                    </div>
                    <p class="mb-1"><strong>Mã:</strong> ${semester.maHocKy}</p>
                    <p class="mb-1"><strong>Năm học:</strong> ${semester.tenNamHoc || 'N/A'} (${semester.maNamHoc || 'N/A'})</p>
                    <p class="mb-1"><strong>Thời gian:</strong> ${formatDate(semester.ngayBatDau)} - ${formatDate(semester.ngayKetThuc)}</p>
                    <p class="mb-1"><strong>Tổng số ngày:</strong> ${semester.tongSoNgay || 0}</p>
                    ${semester.moTa ? `<p class="mb-2 text-muted">${semester.moTa}</p>` : ''}
                </div>
                <div class="col-md-4 text-end">
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${semester.tiLePhanTram || 0}%"></div>
                    </div>
                    <small class="text-muted d-block mb-3">Tiến độ: ${Math.round(semester.tiLePhanTram || 0)}%</small>

                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-outline-success" onclick="editSemester('${semester.maHocKy}')">
                            <i class="fas fa-edit"></i> Sửa
                        </button>
                        ${!semester.isCurrent ? `
                            <button class="btn btn-outline-warning" onclick="setAsCurrentSemester('${semester.maHocKy}')">
                                <i class="fas fa-star"></i> Đặt hiện tại
                            </button>
                        ` : ''}
                        <!-- Dropdown menu cho xóa -->
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="softDeleteSemester('${semester.maHocKy}')">
                                            <i class="fas fa-trash-alt me-2 text-warning"></i>Xóa mềm
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="removeSemesterFromYear('${semester.maNamHoc}', '${semester.maHocKy}')">
                                            <i class="fas fa-unlink me-2 text-info"></i>Xóa khỏi năm học
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="hardDeleteSemester('${semester.maHocKy}')">
                                            <i class="fas fa-trash me-2"></i>Xóa vĩnh viễn
                                        </a>
                                    </li>
                                </ul>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    }

    // Modal Functions
    function openCreateAcademicYearModal() {
        document.getElementById('academicYearModalTitle').textContent = 'Tạo năm học';
        document.getElementById('academicYearForm').reset();
        document.getElementById('academicYearId').value = '';
        document.getElementById('isActiveNamHoc').checked = true;
        document.getElementById('isCurrentNamHoc').checked = false;

        const modal = new bootstrap.Modal(document.getElementById('academicYearModal'));
        modal.show();
    }

    function openCreateSemesterModal() {
        document.getElementById('semesterModalTitle').textContent = 'Tạo học kỳ';
        document.getElementById('semesterForm').reset();
        document.getElementById('semesterId').value = '';
        document.getElementById('isActiveHocKy').checked = true;
        document.getElementById('isCurrentHocKy').checked = false;

        // Thêm dropdown chọn năm học nếu chưa có
        addNamHocSelectToSemesterModal();

        const modal = new bootstrap.Modal(document.getElementById('semesterModal'));
        modal.show();
    }
    function addNamHocSelectToSemesterModal() {
        const existingSelect = document.getElementById('chonNamHocChoHocKy');
        if (existingSelect) return; // Đã có rồi

        const form = document.getElementById('semesterForm');
        const moTaDiv = form.querySelector('#moTaHocKy').closest('.mb-3');

        // Tạo div chọn năm học
        const namHocDiv = document.createElement('div');
        namHocDiv.className = 'mb-3';
        namHocDiv.innerHTML = `
        <label for="chonNamHocChoHocKy" class="form-label">Năm học <span class="text-danger">*</span></label>
        <select class="form-select" id="chonNamHocChoHocKy" required>
            <option value="">Chọn năm học</option>
        </select>
        <small class="form-text text-muted">Học kỳ sẽ được tạo trong năm học này</small>
    `;

        // Thêm vào trước phần mô tả
        form.insertBefore(namHocDiv, moTaDiv);

        // Populate năm học options
        const select = document.getElementById('chonNamHocChoHocKy');
        academicYears.filter(year => year.isActive).forEach(year => {
            const option = document.createElement('option');
            option.value = year.maNamHoc;
            option.textContent = year.tenNamHoc;
            if (year.isCurrent) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    function addThuTuFieldToSemesterModal() {
        const existingField = document.getElementById('thuTuHocKy');
        if (existingField) return; // Đã có rồi

        const form = document.getElementById('semesterForm');
        const ngayKetThucDiv = form.querySelector('#ngayKetThucHocKy').closest('.col-md-6');

        // Tạo field thứ tự
        const thuTuDiv = document.createElement('div');
        thuTuDiv.className = 'col-md-6';
        thuTuDiv.innerHTML = `
        <div class="mb-3">
            <label for="thuTuHocKy" class="form-label">Thứ tự học kỳ</label>
            <select class="form-select" id="thuTuHocKy">
                <option value="">Tự động</option>
                <option value="1">Học kỳ 1</option>
                <option value="2">Học kỳ 2</option>
                <option value="3">Học kỳ 3</option>
                <option value="4">Học kỳ hè</option>
            </select>
            <small class="form-text text-muted">Để trống sẽ tự động đánh số thứ tự</small>
        </div>
    `;

        // Thêm vào row chứa ngày kết thúc
        ngayKetThucDiv.parentNode.appendChild(thuTuDiv);
    }

    async function saveAcademicYear() {
        const form = document.getElementById('academicYearForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btnText = document.querySelector('#academicYearModal .btn-text');
        const spinner = document.querySelector('#academicYearModal .spinner-border');

        btnText.textContent = 'Đang lưu...';
        spinner.classList.remove('d-none');

        const yearData = {
            maNamHoc: document.getElementById('maNamHoc').value,
            tenNamHoc: document.getElementById('tenNamHoc').value,
            ngayBatDau: document.getElementById('ngayBatDauNamHoc').value,
            ngayKetThuc: document.getElementById('ngayKetThucNamHoc').value,
            moTa: document.getElementById('moTaNamHoc').value,
            isActive: document.getElementById('isActiveNamHoc').checked,
            isCurrent: document.getElementById('isCurrentNamHoc').checked
        };

        try {
            const academicYearId = document.getElementById('academicYearId').value;
            const url = academicYearId ?
                `${API_BASE}/namhoc/${academicYearId}` :
                `${API_BASE}/namhoc`;
            const method = academicYearId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(yearData)
            });

            if (response.ok) {
                showNotification(
                    academicYearId ? 'Cập nhật năm học thành công!' : 'Tạo năm học thành công!',
                    'success'
                );
                bootstrap.Modal.getInstance(document.getElementById('academicYearModal')).hide();
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }
        } catch (error) {
            console.error('Error saving academic year:', error);
            showNotification('Lỗi khi lưu: ' + error.message, 'error');
        } finally {
            btnText.textContent = 'Lưu';
            spinner.classList.add('d-none');
        }
    }

    async function createWithSemesters() {
        const form = document.getElementById('academicYearForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const yearData = {
            maNamHoc: document.getElementById('maNamHoc').value,
            tenNamHoc: document.getElementById('tenNamHoc').value,
            ngayBatDau: document.getElementById('ngayBatDauNamHoc').value,
            ngayKetThuc: document.getElementById('ngayKetThucNamHoc').value,
            moTa: document.getElementById('moTaNamHoc').value,
            isActive: document.getElementById('isActiveNamHoc').checked,
            isCurrent: document.getElementById('isCurrentNamHoc').checked
        };

        try {
            // Tạo năm học trước
            const response = await fetch(`${API_BASE}/namhoc`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(yearData)
            });

            if (response.ok) {
                // Sau đó tạo học kỳ mặc định
                const createSemestersResponse = await fetch(`${API_BASE}/hockynamhoc/namhoc/${yearData.maNamHoc}/create-default-semesters`, {
                    method: 'POST'
                });

                if (createSemestersResponse.ok) {
                    showNotification('Tạo năm học và học kỳ mặc định thành công!', 'success');
                } else {
                    showNotification('Tạo năm học thành công, nhưng có lỗi khi tạo học kỳ mặc định', 'warning');
                }
            } else {
                const error = await response.text();
                throw new Error(error);
            }

            bootstrap.Modal.getInstance(document.getElementById('academicYearModal')).hide();
            await initializePage();
        } catch (error) {
            console.error('Error creating with semesters:', error);
            showNotification('Lỗi khi tạo: ' + error.message, 'error');
        }
    }

    async function saveSemester() {
        const form = document.getElementById('semesterForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const btnText = document.querySelector('#semesterModal .btn-text');
        const spinner = document.querySelector('#semesterModal .spinner-border');

        btnText.textContent = 'Đang lưu...';
        spinner.classList.remove('d-none');

        const semesterData = {
            maHocKy: document.getElementById('maHocKy').value,
            tenHocKy: document.getElementById('tenHocKy').value,
            ngayBatDau: document.getElementById('ngayBatDauHocKy').value,
            ngayKetThuc: document.getElementById('ngayKetThucHocKy').value,
            moTa: document.getElementById('moTaHocKy').value,
            thuTu: document.getElementById('thuTuHocKy') ? parseInt(document.getElementById('thuTuHocKy').value) : null
        };

        try {
            const semesterId = document.getElementById('semesterId').value;

            if (semesterId) {
                // Cập nhật học kỳ hiện có
                const response = await fetch(`${API_BASE}/hocky/${semesterId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...semesterData,
                        isActive: document.getElementById('isActiveHocKy').checked,
                        isCurrent: document.getElementById('isCurrentHocKy').checked
                    })
                });

                if (response.ok) {
                    showNotification('Cập nhật học kỳ thành công!', 'success');
                } else {
                    throw new Error(await response.text());
                }
            } else {
                // Tạo học kỳ mới - cần chọn năm học
                const selectedNamHoc = document.getElementById('chonNamHocChoHocKy').value;
                if (!selectedNamHoc) {
                    showNotification('Vui lòng chọn năm học cho học kỳ!', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${selectedNamHoc}/hocky`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(semesterData)
                });

                if (response.ok) {
                    showNotification('Tạo học kỳ thành công!', 'success');
                } else {
                    throw new Error(await response.text());
                }
            }

            bootstrap.Modal.getInstance(document.getElementById('semesterModal')).hide();
            await initializePage();
        } catch (error) {
            console.error('Error saving semester:', error);
            showNotification('Lỗi khi lưu: ' + error.message, 'error');
        } finally {
            btnText.textContent = 'Lưu';
            spinner.classList.add('d-none');
        }
    }

    // Edit Functions
    function editAcademicYear(maNamHoc) {
        const year = academicYears.find(y => y.maNamHoc === maNamHoc);
        if (!year) return;

        document.getElementById('academicYearModalTitle').textContent = 'Sửa năm học';
        document.getElementById('academicYearId').value = year.maNamHoc;
        document.getElementById('maNamHoc').value = year.maNamHoc;
        document.getElementById('tenNamHoc').value = year.tenNamHoc;
        document.getElementById('ngayBatDauNamHoc').value = year.ngayBatDau;
        document.getElementById('ngayKetThucNamHoc').value = year.ngayKetThuc;
        document.getElementById('moTaNamHoc').value = year.moTa || '';
        document.getElementById('isActiveNamHoc').checked = year.isActive;
        document.getElementById('isCurrentNamHoc').checked = year.isCurrent;

        const modal = new bootstrap.Modal(document.getElementById('academicYearModal'));
        modal.show();
    }

    function editSemester(maHocKy) {
        const semester = semesters.find(s => s.maHocKy === maHocKy);
        if (!semester) return;

        document.getElementById('semesterModalTitle').textContent = 'Sửa học kỳ';
        document.getElementById('semesterId').value = semester.maHocKy;
        document.getElementById('maHocKy').value = semester.maHocKy;
        document.getElementById('tenHocKy').value = semester.tenHocKy;
        document.getElementById('ngayBatDauHocKy').value = semester.ngayBatDau;
        document.getElementById('ngayKetThucHocKy').value = semester.ngayKetThuc;
        document.getElementById('moTaHocKy').value = semester.moTa || '';
        document.getElementById('isActiveHocKy').checked = semester.isActive;
        document.getElementById('isCurrentHocKy').checked = semester.isCurrent;

        // Thêm các fields nếu chưa có
        addNamHocSelectToSemesterModal();
        addThuTuFieldToSemesterModal();

        // Set values cho fields mới
        if (semester.maNamHoc) {
            document.getElementById('chonNamHocChoHocKy').value = semester.maNamHoc;
            document.getElementById('chonNamHocChoHocKy').disabled = true; // Không cho đổi năm học khi edit
        }
        if (semester.thuTu) {
            document.getElementById('thuTuHocKy').value = semester.thuTu;
        }

        const modal = new bootstrap.Modal(document.getElementById('semesterModal'));
        modal.show();
    }

    // Set Current Functions
    async function setAsCurrentAcademicYear(maNamHoc) {
        if (!confirm('Bạn có chắc chắn muốn đặt năm học này làm hiện tại?')) return;

        try {
            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/set-current`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification('Đã đặt năm học làm hiện tại!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to set current');
            }
        } catch (error) {
            console.error('Error setting current academic year:', error);
            showNotification('Lỗi khi đặt năm học hiện tại', 'error');
        }
    }

    async function setAsCurrentSemester(maHocKy) {
        if (!confirm('Bạn có chắc chắn muốn đặt học kỳ này làm hiện tại?')) return;

        try {
            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/set-current`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification('Đã đặt học kỳ làm hiện tại!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to set current');
            }
        } catch (error) {
            console.error('Error setting current semester:', error);
            showNotification('Lỗi khi đặt học kỳ hiện tại', 'error');
        }
    }

    // Delete Functions
    async function deleteAcademicYear(maNamHoc) {
        if (!confirm('Bạn có chắc chắn muốn xóa năm học này?')) return;

        try {
            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Xóa năm học thành công!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (error) {
            console.error('Error deleting academic year:', error);
            showNotification('Lỗi khi xóa năm học', 'error');
        }
    }

    async function deleteSemester(maHocKy) {
        if (!confirm('Bạn có chắc chắn muốn xóa học kỳ này?')) return;

        try {
            const response = await fetch(`${API_BASE}/hocky/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification('Xóa học kỳ thành công!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to delete');
            }
        } catch (error) {
            console.error('Error deleting semester:', error);
            showNotification('Lỗi khi xóa học kỳ', 'error');
        }
    }

    // Quick Actions
    async function setNextSemesterAsCurrent() {
        try {
            const upcomingSemesters = semesters.filter(s => s.trangThai === 'Chưa bắt đầu')
                .sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

            if (upcomingSemesters.length === 0) {
                showNotification('Không có học kỳ sắp tới nào!', 'warning');
                return;
            }

            const nextSemester = upcomingSemesters[0];
            await setAsCurrentSemester(nextSemester.maHocKy);
        } catch (error) {
            console.error('Error setting next semester:', error);
            showNotification('Lỗi khi chuyển học kỳ tiếp theo', 'error');
        }
    }

    async function setNextAcademicYearAsCurrent() {
        try {
            const upcomingYears = academicYears.filter(y => y.trangThai === 'Chưa bắt đầu')
                .sort((a, b) => new Date(a.ngayBatDau) - new Date(b.ngayBatDau));

            if (upcomingYears.length === 0) {
                showNotification('Không có năm học sắp tới nào!', 'warning');
                return;
            }

            const nextYear = upcomingYears[0];
            await setAsCurrentAcademicYear(nextYear.maNamHoc);
        } catch (error) {
            console.error('Error setting next academic year:', error);
            showNotification('Lỗi khi chuyển năm học tiếp theo', 'error');
        }
    }

    async function generateNextAcademicYear() {
        try {
            const currentYear = academicYears.find(y => y.isCurrent);
            if (!currentYear) {
                showNotification('Không có năm học hiện tại để tham chiếu!', 'warning');
                return;
            }

            // Tự động tạo năm học kế tiếp
            const nextStartYear = currentYear.endYear || new Date(currentYear.ngayKetThuc).getFullYear();
            const nextEndYear = nextStartYear + 1;

            const nextYearData = {
                maNamHoc: `${nextStartYear}-${nextEndYear}`,
                tenNamHoc: `Năm học ${nextStartYear}-${nextEndYear}`,
                ngayBatDau: `${nextStartYear}-09-01`, // Thường bắt đầu tháng 9
                ngayKetThuc: `${nextEndYear}-06-30`, // Kết thúc tháng 6
                moTa: `Năm học ${nextStartYear}-${nextEndYear} được tạo tự động`,
                isActive: true,
                isCurrent: false
            };

            const response = await fetch(`${API_BASE}/namhoc/with-semesters`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(nextYearData)
            });

            if (response.ok) {
                showNotification('Tạo năm học kế tiếp thành công!', 'success');
                await initializePage();
            } else {
                throw new Error('Failed to generate next academic year');
            }
        } catch (error) {
            console.error('Error generating next academic year:', error);
            showNotification('Lỗi khi tạo năm học kế tiếp', 'error');
        }
    }

    // Filter Functions
    function filterAcademicYears(filter) {
        currentFilter = filter;
        renderAcademicYearsList();

        // Update button states
        document.querySelectorAll('#academic-years .btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary');
    }

    function filterSemesters(filter) {
        currentFilter = filter;
        renderSemestersList();

        // Update button states
        document.querySelectorAll('#semesters .btn').forEach(btn => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
        });
        event.target.classList.remove('btn-outline-success');
        event.target.classList.add('btn-success');
    }

    // Validation Functions
    function validateAcademicYearDates() {
        const startDate = document.getElementById('ngayBatDauNamHoc').value;
        const endDate = document.getElementById('ngayKetThucNamHoc').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffMonths = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());

            if (end <= start) {
                showNotification('Ngày kết thúc phải sau ngày bắt đầu!', 'error');
                document.getElementById('ngayKetThucNamHoc').value = '';
                return false;
            }

            if (diffMonths < 6) {
                showNotification('Năm học phải kéo dài ít nhất 6 tháng!', 'warning');
                return false;
            }
        }

        return true;
    }

    function validateSemesterDates() {
        const startDate = document.getElementById('ngayBatDauHocKy').value;
        const endDate = document.getElementById('ngayKetThucHocKy').value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            if (end <= start) {
                showNotification('Ngày kết thúc phải sau ngày bắt đầu!', 'error');
                document.getElementById('ngayKetThucHocKy').value = '';
                return false;
            }
        }

        return true;
    }

    // Utility Functions
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('vi-VN');
    }

    function getStatusClass(status) {
        switch(status) {
            case 'Đang diễn ra': return 'ongoing';
            case 'Chưa bắt đầu': return 'upcoming';
            case 'Đã kết thúc': return 'finished';
            default: return 'finished';
        }
    }

    async function refreshData() {
        await initializePage();
        showNotification('Dữ liệu đã được làm mới!', 'success');
    }

    function showNotification(message, type = 'info') {
        const container = document.getElementById('notificationContainer');
        const alertClass = type === 'error' ? 'danger' : type;
        const iconClass = {
            success: 'check-circle',
            error: 'exclamation-triangle',
            warning: 'exclamation-circle',
            info: 'info-circle'
        }[type] || 'info-circle';

        const alertHtml = `
           <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
               <i class="fas fa-${iconClass} me-2"></i>
               ${message}
               <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
           </div>
       `;

        container.insertAdjacentHTML('beforeend', alertHtml);

        // Auto remove after 5 seconds
        setTimeout(() => {
            const alerts = container.querySelectorAll('.alert');
            if (alerts.length > 0) {
                alerts[0].remove();
            }
        }, 5000);
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');

        if (sidebar && mainContent) {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }
    }
    // ===== THÊM VÀO CUỐI FILE cauhinh-hocky.html (TRONG THẺ <script>) =====

    /**
     * Tạo học kỳ mặc định cho năm học sử dụng bảng hoc_ky_nam_hoc
     */
    // Thay thế function createSemestersForYear trong cauhinh-hocky.html

    /**
     * Tạo học kỳ mặc định cho năm học sử dụng bảng hoc_ky_nam_hoc (3 học kỳ)
     */
    async function createSemestersForYear(maNamHoc) {
        try {
            console.log('🔄 Creating semesters for academic year:', maNamHoc);

            const confirmMessage = `Tạo học kỳ mặc định cho năm học ${maNamHoc}?\n\n` +
                `Hệ thống sẽ tạo:\n` +
                `• Học kỳ 1: Tháng 9 - Tháng 12 (35% thời gian)\n` +
                `• Học kỳ 2: Tháng 1 - Tháng 5 (40% thời gian)\n` +
                `• Học kỳ hè: Tháng 6 - Tháng 8 (20% thời gian)\n\n` +
                `Xác nhận tạo?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading('Đang tạo 3 học kỳ mặc định...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/create-semesters`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const result = await response.json();

            if (result.createdSemesters && result.createdSemesters > 0) {
                showNotification(
                    `✅ Đã tạo thành công ${result.createdSemesters} học kỳ cho năm học ${maNamHoc}!`,
                    'success'
                );
                console.log('✅ Created semesters:', result.semesters);
                await initializePage();
            } else {
                showNotification(result.message || 'Có lỗi khi tạo học kỳ', 'warning');
            }

        } catch (error) {
            console.error('❌ Error creating semesters:', error);
            showNotification('Lỗi khi tạo học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Cập nhật thông báo trong function showSemesterListModal (nếu có)
    function showSemesterListModal(maNamHoc, semesters) {
        const modalTitle = `Danh sách học kỳ - ${maNamHoc}`;
        const semestersList = semesters.map((semester, index) => {
            const trangThaiClass = {
                'Chưa bắt đầu': 'text-info',
                'Đang diễn ra': 'text-success',
                'Đã kết thúc': 'text-secondary'
            }[semester.trangThai] || 'text-muted';

            return `
            <div class="semester-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${semester.tenHocKy}</h6>
                        <small class="text-muted">Mã: ${semester.maHocKy}</small>
                        <div class="mt-1">
                            <span class="badge bg-primary">Thứ tự: ${semester.thuTu || (index + 1)}</span>
                            <span class="badge ${trangThaiClass.replace('text-', 'bg-')}">${semester.trangThai}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <small class="d-block">${semester.ngayBatDau} → ${semester.ngayKetThuc}</small>
                        <small class="text-muted">${semester.soNgay || 0} ngày</small>
                    </div>
                </div>
                ${semester.moTa ? `<p class="mt-2 mb-0 text-muted small">${semester.moTa}</p>` : ''}
            </div>
        `;
        }).join('');

        // Tạo và hiển thị modal (implementation tùy thuộc vào framework UI bạn dùng)
        const modalContent = `
        <div class="modal fade" id="semesterListModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${modalTitle}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-info">Tổng: ${semesters.length} học kỳ</span>
                        </div>
                        ${semestersList}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Thêm modal vào DOM và hiển thị
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('semesterListModal'));
        modal.show();

        // Xóa modal khi đóng
        document.getElementById('semesterListModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    /**
     * Xem danh sách học kỳ của năm học
     */
    async function viewSemestersOfYear(maNamHoc) {
        try {
            console.log('👁️ Viewing semesters for academic year:', maNamHoc);

            showLoading('Đang tải danh sách học kỳ...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const semesters = await response.json();

            if (semesters.length === 0) {
                showNotification(`Năm học ${maNamHoc} chưa có học kỳ nào!`, 'info');
                return;
            }

            // Hiển thị modal với danh sách học kỳ
            showSemesterListModal(maNamHoc, semesters);

        } catch (error) {
            console.error('❌ Error viewing semesters:', error);
            showNotification('Lỗi khi xem danh sách học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xóa tất cả học kỳ của năm học
     */
    async function deleteSemestersOfYear(maNamHoc) {
        try {
            const confirmMessage = `Bạn có chắc chắn muốn xóa TẤT CẢ học kỳ của năm học ${maNamHoc}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Xóa mềm tất cả học kỳ\n` +
                `• Xóa mềm relationships trong bảng hoc_ky_nam_hoc\n\n` +
                `Thao tác này KHÔNG THỂ hoàn tác!`;

            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading('Đang xóa học kỳ...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const result = await response.json();

            showNotification(result.message, 'success');
            await initializePage();

        } catch (error) {
            console.error('❌ Error deleting semesters:', error);
            showNotification('Lỗi khi xóa học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Hiển thị modal danh sách học kỳ của năm học
     */
    function showSemesterListModal(maNamHoc, semesters) {
        const semesterList = semesters.map(s => `
            <div class="semester-item border rounded p-3 mb-2" style="background-color: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-primary mb-1">${s.tenHocKy}</h6>
                        <p class="mb-1 small"><strong>Mã:</strong> ${s.maHocKy}</p>
                        <p class="mb-1 small"><strong>Thời gian:</strong> ${formatDate(s.ngayBatDau)} - ${formatDate(s.ngayKetThuc)}</p>
                        ${s.moTa ? `<p class="mb-2 small text-muted">${s.moTa}</p>` : ''}
                    </div>
                    <div class="text-end">
                        <div class="mb-2">
                            <span class="badge ${s.isActive ? 'bg-success' : 'bg-secondary'} me-1">
                                ${s.isActive ? 'Hoạt động' : 'Tạm dừng'}
                            </span>
                            ${s.isCurrent ? '<span class="badge bg-primary">Hiện tại</span>' : ''}
                        </div>
                        <div class="btn-group-vertical btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editSemester('${s.maHocKy}')">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            ${!s.isCurrent ? `
                                <button class="btn btn-outline-warning btn-sm" onclick="setAsCurrentSemester('${s.maHocKy}')">
                                    <i class="fas fa-star"></i> Đặt hiện tại
                                </button>
                            ` : ''}

                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        const modalHtml = `
            <div class="modal fade" id="semesterListModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Danh sách học kỳ - ${maNamHoc}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Năm học này có <strong>${semesters.length}</strong> học kỳ trong bảng <code>hoc_ky_nam_hoc</code>
                            </div>
                            ${semesterList}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" onclick="deleteSemestersOfYear('${maNamHoc}'); bootstrap.Modal.getInstance(document.getElementById('semesterListModal')).hide();">
                                <i class="fas fa-trash me-2"></i>Xóa tất cả học kỳ
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Xóa modal cũ nếu có
        const existingModal = document.getElementById('semesterListModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Thêm modal mới
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('semesterListModal'));
        modal.show();

        // Cleanup khi modal đóng
        document.getElementById('semesterListModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }

    /**
     * Enhanced renderAcademicYearsList để thêm buttons tạo học kỳ
     */
    function renderAcademicYearsList() {
        const container = document.getElementById('academicYearsList');
        let filteredYears = academicYears;

        // Apply filter
        if (currentFilter !== 'all') {
            filteredYears = academicYears.filter(year => {
                switch(currentFilter) {
                    case 'ongoing': return year.trangThai === 'Đang diễn ra';
                    case 'upcoming': return year.trangThai === 'Chưa bắt đầu';
                    case 'finished': return year.trangThai === 'Đã kết thúc';
                    default: return true;
                }
            });
        }

        if (filteredYears.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5>Không có năm học nào</h5>
                    <p class="text-muted">Vui lòng tạo năm học mới</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredYears.map(year => `
            <div class="year-card ${getStatusClass(year.trangThai)}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="text-primary">
                                ${year.tenNamHoc}
                                ${year.isCurrent ? '<span class="badge bg-primary ms-2">Hiện tại</span>' : ''}
                            </h6>
                            <span class="status-badge status-${getStatusClass(year.trangThai)}">${year.trangThai}</span>
                        </div>
                        <p class="mb-1"><strong>Mã:</strong> ${year.maNamHoc}</p>
                        <p class="mb-1"><strong>Thời gian:</strong> ${formatDate(year.ngayBatDau)} - ${formatDate(year.ngayKetThuc)}</p>
                        <p class="mb-1"><strong>Tổng số ngày:</strong> ${year.tongSoNgay || 0}</p>
                        ${year.moTa ? `<p class="mb-2 text-muted">${year.moTa}</p>` : ''}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${year.tiLePhanTram || 0}%"></div>
                        </div>
                        <small class="text-muted d-block mb-3">Tiến độ: ${Math.round(year.tiLePhanTram || 0)}%</small>

                        <div class="btn-group-vertical btn-group-sm">
                            <!-- Button xem học kỳ của năm học -->
                            <button class="btn btn-outline-info" onclick="viewSemestersOfYear('${year.maNamHoc}')" title="Xem học kỳ của năm học">
                                <i class="fas fa-eye"></i> Xem học kỳ
                            </button>

                            <!-- Button tạo học kỳ cho năm học -->
                            <button class="btn btn-outline-success" onclick="createSemestersForYear('${year.maNamHoc}')" title="Tạo học kỳ mặc định cho năm học">
                                <i class="fas fa-plus"></i> Tạo học kỳ
                            </button>

                            <!-- Các button khác -->
                            <button class="btn btn-outline-primary" onclick="editAcademicYear('${year.maNamHoc}')">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            ${!year.isCurrent ? `
                                <button class="btn btn-outline-warning" onclick="setAsCurrentAcademicYear('${year.maNamHoc}')">
                                    <i class="fas fa-star"></i> Đặt hiện tại
                                </button>
                            ` : ''}
                            <!-- Dropdown menu cho xóa -->
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="softDeleteAcademicYear('${year.maNamHoc}')">
                                            <i class="fas fa-trash-alt me-2 text-warning"></i>Xóa mềm
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="hardDeleteAcademicYear('${year.maNamHoc}')">
                                            <i class="fas fa-trash me-2"></i>Xóa vĩnh viễn
                                        </a>
                                    </li>
                                </ul>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    /**
     * Utility functions cho loading và notification
     */
    function showLoading(message = 'Đang xử lý...') {
        let loadingEl = document.getElementById('globalLoading');
        if (!loadingEl) {
            const loadingHtml = `
                <div id="globalLoading" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                     background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div class="bg-white p-4 rounded shadow">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status"></div>
                            <span id="loadingMessage">${message}</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
        } else {
            document.getElementById('loadingMessage').textContent = message;
            loadingEl.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingEl = document.getElementById('globalLoading');
        if (loadingEl) {
            loadingEl.remove();
        }
    }

    // =============== THÊM VÀO cauhinh-hocky.html ===============

    /**
     * Xóa mềm năm học
     */
    async function softDeleteAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `Xóa mềm năm học ${maNamHoc}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Đặt năm học thành trạng thái không hoạt động\n` +
                `• Xóa mềm tất cả học kỳ của năm học\n` +
                `• Có thể khôi phục sau này\n\n` +
                `Xác nhận xóa mềm?`;

            if (!confirm(confirmMessage)) return;

            showLoading('Đang xóa mềm năm học...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`✅ Đã xóa mềm năm học ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error soft deleting academic year:', error);
            showNotification('Lỗi khi xóa mềm năm học: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xóa vĩnh viễn năm học
     */
    async function hardDeleteAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `⚠️ XÓA VĨNH VIỄN năm học ${maNamHoc}?\n\n` +
                `CẢNH BÁO: Thao tác này sẽ:\n` +
                `• Xóa vĩnh viễn năm học khỏi cơ sở dữ liệu\n` +
                `• Xóa vĩnh viễn TẤT CẢ học kỳ của năm học\n` +
                `• KHÔNG THỂ khôi phục sau này\n\n` +
                `Gõ "${maNamHoc}" để xác nhận xóa vĩnh viễn:`;

            const userInput = prompt(confirmMessage);
            if (userInput !== maNamHoc) {
                showNotification('Xác nhận không chính xác. Hủy thao tác.', 'warning');
                return;
            }

            showLoading('Đang xóa vĩnh viễn năm học...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/permanent`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`✅ Đã xóa vĩnh viễn năm học ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error hard deleting academic year:', error);
            showNotification('Lỗi khi xóa vĩnh viễn năm học: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Khôi phục năm học đã xóa mềm
     */
    async function restoreAcademicYear(maNamHoc) {
        try {
            const confirmMessage = `Khôi phục năm học ${maNamHoc}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Kích hoạt lại năm học\n` +
                `• Khôi phục tất cả học kỳ của năm học\n\n` +
                `Xác nhận khôi phục?`;

            if (!confirm(confirmMessage)) return;

            showLoading('Đang khôi phục năm học...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/restore`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification(`✅ Đã khôi phục năm học ${maNamHoc}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error restoring academic year:', error);
            showNotification('Lỗi khi khôi phục năm học: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xóa mềm học kỳ
     */
    async function softDeleteSemester(maHocKy) {
        try {
            const confirmMessage = `Xóa mềm học kỳ ${maHocKy}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Đặt học kỳ thành trạng thái không hoạt động\n` +
                `• Xóa mềm khỏi tất cả năm học\n` +
                `• Có thể khôi phục sau này\n\n` +
                `Xác nhận xóa mềm?`;

            if (!confirm(confirmMessage)) return;

            showLoading('Đang xóa mềm học kỳ...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`✅ Đã xóa mềm học kỳ ${maHocKy}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error soft deleting semester:', error);
            showNotification('Lỗi khi xóa mềm học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xóa học kỳ khỏi năm học cụ thể
     */
    async function removeSemesterFromYear(maNamHoc, maHocKy) {
        try {
            const confirmMessage = `Xóa học kỳ ${maHocKy} khỏi năm học ${maNamHoc}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Xóa mối liên kết giữa học kỳ và năm học\n` +
                `• Cập nhật lại thứ tự các học kỳ còn lại\n` +
                `• Học kỳ vẫn tồn tại và có thể gán cho năm học khác\n\n` +
                `Xác nhận xóa?`;

            if (!confirm(confirmMessage)) return;

            showLoading('Đang xóa học kỳ khỏi năm học...');

            const response = await fetch(`${API_BASE}/namhoc/${maNamHoc}/semesters/${maHocKy}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                showNotification(`✅ ${result.message}`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error removing semester from year:', error);
            showNotification('Lỗi khi xóa học kỳ khỏi năm học: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Khôi phục học kỳ đã xóa mềm
     */
    async function restoreSemester(maHocKy) {
        try {
            const confirmMessage = `Khôi phục học kỳ ${maHocKy}?\n\n` +
                `Thao tác này sẽ:\n` +
                `• Kích hoạt lại học kỳ\n` +
                `• Khôi phục tất cả mối liên kết với năm học\n\n` +
                `Xác nhận khôi phục?`;

            if (!confirm(confirmMessage)) return;

            showLoading('Đang khôi phục học kỳ...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/restore`, {
                method: 'PUT'
            });

            if (response.ok) {
                showNotification(`✅ Đã khôi phục học kỳ ${maHocKy}!`, 'success');
                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error restoring semester:', error);
            showNotification('Lỗi khi khôi phục học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xem danh sách các item đã xóa mềm
     */
    async function viewDeletedItems() {
        try {
            showLoading('Đang tải danh sách đã xóa...');

            // Lấy năm học đã xóa
            const deletedYearsResponse = await fetch(`${API_BASE}/namhoc/deleted`);
            const deletedYears = deletedYearsResponse.ok ? await deletedYearsResponse.json() : [];

            // Lấy học kỳ đã xóa
            const deletedSemestersResponse = await fetch(`${API_BASE}/hocky/deleted`);
            const deletedSemesters = deletedSemestersResponse.ok ? await deletedSemestersResponse.json() : [];

            showDeletedItemsModal(deletedYears, deletedSemesters);

        } catch (error) {
            console.error('❌ Error loading deleted items:', error);
            showNotification('Lỗi khi tải danh sách đã xóa: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Hiển thị modal danh sách đã xóa mềm
     */
    function showDeletedItemsModal(deletedYears, deletedSemesters) {
        const yearsList = deletedYears.map(year => `
        <div class="deleted-item border rounded p-3 mb-2 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-muted">${year.tenNamHoc}</h6>
                    <small class="text-muted">Mã: ${year.maNamHoc}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="restoreAcademicYear('${year.maNamHoc}')">
                        <i class="fas fa-undo"></i> Khôi phục
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="hardDeleteAcademicYear('${year.maNamHoc}')">
                        <i class="fas fa-trash"></i> Xóa vĩnh viễn
                    </button>
                </div>
            </div>
        </div>
    `).join('');

        const semestersList = deletedSemesters.map(semester => `
        <div class="deleted-item border rounded p-3 mb-2 bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1 text-muted">${semester.tenHocKy}</h6>
                    <small class="text-muted">Mã: ${semester.maHocKy}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="restoreSemester('${semester.maHocKy}')">
                        <i class="fas fa-undo"></i> Khôi phục
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="hardDeleteSemester('${semester.maHocKy}')">
                        <i class="fas fa-trash"></i> Xóa vĩnh viễn
                    </button>
                </div>
            </div>
        </div>
    `).join('');

        const modalContent = `
        <div class="modal fade" id="deletedItemsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-trash-restore me-2"></i>Danh Sách Đã Xóa Mềm
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-calendar-alt me-2"></i>Năm Học Đã Xóa
                                    <span class="badge bg-secondary">${deletedYears.length}</span>
                                </h6>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${yearsList || '<p class="text-muted">Không có năm học nào đã xóa mềm</p>'}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-calendar-week me-2"></i>Học Kỳ Đã Xóa
                                    <span class="badge bg-secondary">${deletedSemesters.length}</span>
                                </h6>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${semestersList || '<p class="text-muted">Không có học kỳ nào đã xóa mềm</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Xóa modal cũ nếu có
        const existingModal = document.getElementById('deletedItemsModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Thêm modal mới
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('deletedItemsModal'));
        modal.show();

        // Xóa modal khi đóng
        document.getElementById('deletedItemsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    /**
     * Xóa vĩnh viễn học kỳ
     */
    async function hardDeleteSemester(maHocKy) {
        try {
            const confirmMessage = `⚠️ XÓA VĨNH VIỄN học kỳ ${maHocKy}?\n\n` +
                `CẢNH BÁO: Thao tác này sẽ:\n` +
                `• Xóa vĩnh viễn học kỳ khỏi cơ sở dữ liệu\n` +
                `• Xóa tất cả mối liên kết với năm học\n` +
                `• KHÔNG THỂ khôi phục sau này\n\n` +
                `Gõ "${maHocKy}" để xác nhận xóa vĩnh viễn:`;

            const userInput = prompt(confirmMessage);
            if (userInput !== maHocKy) {
                showNotification('Xác nhận không chính xác. Hủy thao tác.', 'warning');
                return;
            }

            showLoading('Đang xóa vĩnh viễn học kỳ...');

            const response = await fetch(`${API_BASE}/hocky/${maHocKy}/permanent`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showNotification(`✅ Đã xóa vĩnh viễn học kỳ ${maHocKy}!`, 'success');

                // Đóng modal và refresh
                const modal = bootstrap.Modal.getInstance(document.getElementById('deletedItemsModal'));
                if (modal) modal.hide();

                await initializePage();
            } else {
                const error = await response.text();
                throw new Error(error);
            }

        } catch (error) {
            console.error('❌ Error hard deleting semester:', error);
            showNotification('Lỗi khi xóa vĩnh viễn học kỳ: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Cập nhật menu actions để bao gồm các chức năng xóa mềm
     */
    function updateActionMenus() {
        // Thêm nút "Xem đã xóa" vào header
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
            const deletedButton = `
            <button class="btn btn-outline-secondary" onclick="viewDeletedItems()">
                <i class="fas fa-trash-restore me-2"></i>Xem Đã Xóa
            </button>
        `;
            headerActions.insertAdjacentHTML('beforeend', deletedButton);
        }
    }

    // Gọi function để cập nhật menu khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        updateActionMenus();
    });

    function showLoading(message = 'Đang xử lý...') {
        const overlay = `
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="mb-0">${message}</p>
            </div>
        </div>
    `;
        document.body.insertAdjacentHTML('beforeend', overlay);
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    /**
     * Tính toán tiến độ năm học dựa trên các học kỳ bên trong
     */
    async function calculateAcademicYearProgress(maNamHoc) {
        try {
            // Lấy danh sách học kỳ của năm học
            const response = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters-with-progress`);
            if (!response.ok) return 0;

            const semesters = await response.json();
            if (semesters.length === 0) return 0;

            // Tính trọng số dựa trên số ngày của mỗi học kỳ
            let totalWeightedProgress = 0;
            let totalWeight = 0;

            semesters.forEach(semester => {
                const weight = semester.tongSoNgay || 1;
                const progress = semester.tiLePhanTram || 0;

                totalWeightedProgress += (progress * weight);
                totalWeight += weight;
            });

            return totalWeight > 0 ? totalWeightedProgress / totalWeight : 0;
        } catch (error) {
            console.error('Error calculating academic year progress:', error);
            return 0;
        }
    }

    /**
     * Cập nhật trạng thái năm học dựa trên học kỳ
     */
    async function updateAcademicYearStatus(maNamHoc) {
        try {
            const semestersResponse = await fetch(`${API_BASE}/hockynamhoc/namhoc/${maNamHoc}/semesters`);
            if (!semestersResponse.ok) return;

            const semesters = await semestersResponse.json();
            if (semesters.length === 0) return;

            const currentDate = new Date();
            const ongoingSemesters = semesters.filter(s => s.trangThai === 'Đang diễn ra');

            let newStatus = 'Chưa bắt đầu';
            if (ongoingSemesters.length > 0) {
                newStatus = 'Đang diễn ra';
            } else {
                const finishedSemesters = semesters.filter(s => s.trangThai === 'Đã kết thúc');
                if (finishedSemesters.length === semesters.length) {
                    newStatus = 'Đã kết thúc';
                }
            }

            // Cập nhật tiến độ
            const progress = await calculateAcademicYearProgress(maNamHoc);

            // Gọi API để cập nhật
            await fetch(`${API_BASE}/namhoc/${maNamHoc}/update-progress`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    trangThai: newStatus,
                    tiLePhanTram: progress
                })
            });

        } catch (error) {
            console.error('Error updating academic year status:', error);
        }
    }
    /**
     * Initialize sortable functionality
     */
    function initializeSortable() {
        const sortableContainer = document.getElementById('sortableSemesters');
        if (!sortableContainer) return;

        let draggedElement = null;

        // Add drag event listeners to items
        const items = sortableContainer.querySelectorAll('.sortable-item');
        items.forEach(item => {
            item.draggable = true;

            item.addEventListener('dragstart', (e) => {
                draggedElement = item;
                item.classList.add('dragging');
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedElement = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedElement && draggedElement !== item) {
                    const bounding = item.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);

                    if (e.clientY - offset > 0) {
                        item.parentNode.insertBefore(draggedElement, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedElement, item);
                    }

                    // Update order numbers
                    updateOrderNumbers();
                }
            });
        });
    }

    function updateOrderNumbers() {
        const items = document.querySelectorAll('#sortableSemesters .sortable-item');
        items.forEach((item, index) => {
            const badge = item.querySelector('.badge');
            if (badge) {
                badge.textContent = `Thứ tự: ${index + 1}`;
            }
        });
    }

    function getStatusBadgeColor(status) {
        switch(status) {
            case 'Đang diễn ra': return 'success';
            case 'Chưa bắt đầu': return 'warning';
            case 'Đã kết thúc': return 'secondary';
            default: return 'secondary';
        }
    }
</script>
</body>
</html>