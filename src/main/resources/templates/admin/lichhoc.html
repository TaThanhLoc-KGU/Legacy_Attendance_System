<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Lịch học - Face Attendance</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/sidebar.css}" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        /* ===== Z-INDEX MANAGEMENT - FIXED HIERARCHY ===== */

        /* Base modal z-index levels */
        .modal {
            z-index: 1050 !important;
        }

        .modal-backdrop {
            z-index: 1040 !important;
        }

        /* Schedule Modal (Create/Edit) - Level 1 */
        #scheduleModal {
            z-index: 1050 !important;
        }

        #scheduleModal .modal-backdrop {
            z-index: 1040 !important;
        }

        /* Move Room Modal - Level 2 */
        #moveRoomModal {
            z-index: 1055 !important;
        }

        #moveRoomModal .modal-backdrop {
            z-index: 1045 !important;
        }

        /* Semester Schedule Modal - Level 3 */
        #semesterScheduleModal {
            z-index: 1060 !important;
        }

        #semesterScheduleModal .modal-backdrop {
            z-index: 1050 !important;
        }

        #semesterScheduleModal .modal-dialog {
            z-index: 1061 !important;
        }

        /* Schedule Detail Modal - HIGHEST PRIORITY */
        #scheduleDetailModal {
            z-index: 1070 !important;
        }

        #scheduleDetailModal .modal-backdrop {
            z-index: 1060 !important;
        }

        #scheduleDetailModal .modal-dialog {
            z-index: 1071 !important;
        }

        /* Select2 Dropdown Management */
        .select2-container {
            z-index: 1080 !important;
        }

        .select2-dropdown {
            z-index: 1080 !important;
        }

        /* Select2 trong các modal cụ thể */
        #scheduleModal .select2-container {
            z-index: 1052 !important;
        }

        #scheduleModal .select2-dropdown {
            z-index: 1053 !important;
        }

        #semesterScheduleModal .select2-container {
            z-index: 1062 !important;
        }

        #semesterScheduleModal .select2-dropdown {
            z-index: 1063 !important;
        }

        #moveRoomModal .select2-container {
            z-index: 1057 !important;
        }

        #moveRoomModal .select2-dropdown {
            z-index: 1058 !important;
        }

        /* Đảm bảo Schedule Detail Modal luôn ở trên cùng */
        #scheduleDetailModal.show {
            z-index: 1070 !important;
        }

        #scheduleDetailModal.show .modal-backdrop {
            z-index: 1060 !important;
        }

        /* Ẩn Select2 dropdown khi Schedule Detail Modal mở */
        body.modal-open #scheduleDetailModal.show ~ .select2-container .select2-dropdown,
        body.modal-open #scheduleDetailModal.show ~ .select2-dropdown {
            display: none !important;
        }

        /* ===== FILTER SECTION SELECT2 MANAGEMENT ===== */
        .filter-section .select2-container {
            z-index: 1030 !important;
        }

        .filter-section .select2-dropdown {
            z-index: 1030 !important;
        }

        /* Ẩn filter dropdowns khi có modal mở */
        body.modal-open .filter-section .select2-container .select2-dropdown,
        body.modal-open .filter-section .select2-dropdown {
            display: none !important;
        }

        /* Đảm bảo filter dropdowns không hiển thị khi modal đang mở */
        .modal.show ~ * .filter-section .select2-dropdown {
            display: none !important;
        }

        /* Override cho các filter dropdown cụ thể */
        #filterGiangVien + .select2-container .select2-dropdown,
        #filterPhongHoc + .select2-container .select2-dropdown,
        #filterMonHoc + .select2-container .select2-dropdown,
        #filterKhoa + .select2-container .select2-dropdown {
            z-index: 1030 !important;
        }

        /* Khi modal mở, force ẩn tất cả filter dropdowns */
        body.modal-open #filterGiangVien + .select2-container .select2-dropdown,
        body.modal-open #filterPhongHoc + .select2-container .select2-dropdown,
        body.modal-open #filterMonHoc + .select2-container .select2-dropdown,
        body.modal-open #filterKhoa + .select2-container .select2-dropdown {
            display: none !important;
            visibility: hidden !important;
        }

        /* Loading Overlay - Cao nhất */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999 !important;
        }

        /* Notification Container - Cao nhất */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000 !important;
            max-width: 400px;
        }

        /* ===== LAYOUT STYLES ===== */
        .schedule-calendar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .calendar-header {
            background: var(--primary-color);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }

        .calendar-controls {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .time-column {
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            min-width: 120px;
        }

        .time-slot {
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem;
            font-size: 0.875rem;
            text-align: center;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-weight: 500;
        }

        .day-column {
            border-right: 1px solid #e9ecef;
            min-height: 720px;
            position: relative;
            flex: 1;
            min-width: 140px;
        }

        .day-header {
            background: #495057;
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 2px solid #dee2e6;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Responsive cho mobile */
        @media (max-width: 768px) {
            .day-header {
                padding: 1.2rem 0.5rem;
                min-height: 70px;
                font-size: 0.9rem;
            }
        }

        .day-content {
            position: relative;
            height: 720px;
            background: #fafafa;
        }

        /* ===== SCHEDULE ITEMS ===== */
        .schedule-item {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 10px 14px;
            margin: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
            z-index: 10;
            left: 6px;
            right: 6px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .schedule-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .schedule-item.conflict {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            animation: pulse 2s infinite;
            border-color: rgba(255,255,255,0.4);
        }

        .schedule-item.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: scale(1.05);
            border-color: rgba(255,255,255,0.5);
        }

        .schedule-item .title {
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .schedule-item .info {
            font-size: 0.75rem;
            opacity: 0.95;
            line-height: 1.3;
        }

        .schedule-item .info div {
            margin-bottom: 2px;
        }





        /* ===== GRID VIEW IMPROVEMENTS ===== */
        .schedule-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            gap: 2px;
            background: #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .grid-cell {
            background: white;
            min-height: 70px;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .grid-cell:hover {
            background: #f8f9fa;
        }

        .time-grid-slot {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: #e9ecef;
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        .day-grid-header {
            background: #495057;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            padding: 1rem;
        }

        /* ===== RESPONSIVE IMPROVEMENTS ===== */
        @media (max-width: 1200px) {
            .day-column {
                min-width: 120px;
            }

            .schedule-item {
                font-size: 0.8rem;
                padding: 8px 10px;
            }

            .schedule-item .title {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 768px) {
            .time-column {
                min-width: 100px;
            }

            .day-column {
                min-width: 100px;
            }

            .schedule-item {
                font-size: 0.75rem;
                padding: 6px 8px;
                left: 4px;
                right: 4px;
            }

            .schedule-item .title {
                font-size: 0.8rem;
            }

            .schedule-item .info {
                font-size: 0.7rem;
            }
        }

        /* ===== CALENDAR DATE DISPLAY ===== */
        .day-date {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
            margin-top: 4px;
        }

        .day-date.today {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px auto 0;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.5);
        }

        /* ===== SEMESTER SELECTOR IMPROVEMENTS ===== */
        .semester-selector {
            background: linear-gradient(135deg, #0c5460 0%, #17a2b8 100%) !important;
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(12, 84, 96, 0.3);
        }

        .semester-selector h5 {
            color: white !important;
            font-weight: 600;
        }

        .semester-selector .form-select {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            border-radius: 10px;
            font-weight: 500;
        }

        .semester-selector .form-select:focus {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
        }

        .semester-selector .form-select option {
            background: #495057;
            color: white;
        }

        /* ===== TABLE IMPROVEMENTS ===== */
        .list-view-table .schedule-row {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .list-view-table .schedule-row:hover {
            background-color: rgba(102, 126, 234, 0.08);
            transform: translateX(3px);
            border-left-color: #667eea;
        }

        .list-view-table .schedule-row.table-primary {
            background-color: rgba(102, 126, 234, 0.15);
            border-left-color: #667eea;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0% { box-shadow: 0 2px 8px rgba(255, 65, 108, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(255, 65, 108, 0.6); }
            100% { box-shadow: 0 2px 8px rgba(255, 65, 108, 0.3); }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== UI COMPONENTS ===== */
        .conflict-badge {
            background: #dc3545;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            animation: blink 1s infinite;
        }

        .filter-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .view-toggle {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .view-toggle .btn-group .btn {
            border-radius: 25px;
            margin: 0 3px;
            padding: 0.5rem 1.5rem;
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
            justify-content: center;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stats-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            background: white;
            justify-content: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stats-change {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stats-change.positive {
            color: #28a745;
        }

        .stats-change.negative {
            color: #dc3545;
        }

        /* ===== TABLE STYLES ===== */
        .time-cell {
            font-weight: 600;
            color: #495057;
        }

        .conflict-indicator {
            color: #dc3545;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        /* ===== SEMESTER COMPONENTS ===== */
        .semester-info {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* ===== ACTION COMPONENTS ===== */
        .bulk-actions {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-action {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* ===== MODAL STYLES ===== */
        .modal-lg {
            max-width: 900px;
        }

        .conflict-warning {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .conflict-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .schedule-summary {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* Loading Spinner */
        .loading-spinner-circle {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 300px;
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .notification {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification.warning {
            border-left-color: #ffc107;
        }

        .notification.info {
            border-left-color: #17a2b8;
        }

        /* ===== SELECT2 CUSTOMIZATION ===== */
        .select2-container--default .select2-selection--single {
            height: 38px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-left: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        /* ===== CALENDAR NAVIGATION ===== */
        .calendar-controls .btn-group .btn.active {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Filter dropdown specific styling */
        .filter-dropdown {
            z-index: 1030 !important;
        }

        .select2-container--bootstrap-5 .filter-dropdown {
            z-index: 1030 !important;
        }
    </style>
</head>
<body>
<div class="main-wrapper">
    <!-- Include Sidebar Component -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="page-title">
                        <i class="fas fa-calendar-alt me-2"></i>Quản lý Lịch học
                    </h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-success me-2" onclick="openSemesterScheduleModal()">
                        <i class="fas fa-calendar-plus me-2"></i>Sắp lịch học kỳ
                    </button>
                    <button class="btn btn-primary me-2" onclick="openCreateModal()">
                        <i class="fas fa-plus me-2"></i>Tạo lịch học
                    </button>
                    <button class="btn btn-warning me-2" onclick="checkAllConflicts()">
                        <i class="fas fa-exclamation-triangle me-2"></i>Kiểm tra trùng lịch
                    </button>
                    <button class="btn btn-info" onclick="exportSchedule()">
                        <i class="fas fa-download me-2"></i>Xuất lịch
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Semester Selector -->
            <div class="semester-selector">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-graduation-cap me-2"></i>Chọn học kỳ
                        </h5>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="semesterSelect">
                            <option value="">Tất cả học kỳ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="yearSelect">
                            <option value="">Tất cả năm học</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-light" onclick="loadCurrentSemester()">
                            <i class="fas fa-sync-alt me-2"></i>Học kỳ hiện tại
                        </button>
                    </div>
                </div>
            </div>

            <!-- Current Semester Info -->
            <div id="semesterInfo" class="semester-info" style="display: none;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1 text-white">
                            <i class="fas fa-info-circle me-2"></i>Thông tin học kỳ hiện tại
                        </h6>
                        <div id="semesterDetails"></div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-sm" onclick="manageSemesterSchedule()">
                            <i class="fas fa-cog me-2"></i>Quản lý lịch học kỳ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-calendar-alt stats-icon text-primary"></i>
                        <div class="stats-number" id="totalSchedules">0</div>
                        <div class="stats-label">Tổng lịch học</div>
                        <div class="stats-change positive" id="scheduleChange">+0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-chalkboard-teacher stats-icon text-success"></i>
                        <div class="stats-number" id="activeTeachers">0</div>
                        <div class="stats-label">Giảng viên có lịch</div>
                        <div class="stats-change positive" id="teacherChange">+0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-door-open stats-icon text-warning"></i>
                        <div class="stats-number" id="usedRooms">0</div>
                        <div class="stats-label">Phòng học sử dụng</div>
                        <div class="stats-change positive" id="roomChange">+0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-exclamation-triangle stats-icon text-danger"></i>
                        <div class="stats-number" id="conflicts">0</div>
                        <div class="stats-label">Trùng lịch</div>
                        <div class="stats-change negative" id="conflictChange">0</div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">
                            <i class="fas fa-tasks me-2"></i>Thao tác hàng loạt
                        </h6>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 justify-content-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="selectAllSchedules()">
                                <i class="fas fa-check-square me-1"></i>Chọn tất cả
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                <i class="fas fa-times me-1"></i>Bỏ chọn
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteSelectedSchedules()" disabled id="deleteSelectedBtn">
                                <i class="fas fa-trash me-1"></i>Xóa đã chọn
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="moveSelectedSchedules()" disabled id="moveSelectedBtn">
                                <i class="fas fa-exchange-alt me-1"></i>Chuyển phòng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-eye me-2"></i>Chế độ xem
                    </h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="calendarView" checked>
                        <label class="btn btn-outline-primary" for="calendarView">
                            <i class="fas fa-calendar me-2"></i>Lịch tuần
                        </label>

                        <input type="radio" class="btn-check" name="viewMode" id="gridView">
                        <label class="btn btn-outline-primary" for="gridView">
                            <i class="fas fa-th me-2"></i>Lưới
                        </label>

                        <input type="radio" class="btn-check" name="viewMode" id="listView">
                        <label class="btn btn-outline-primary" for="listView">
                            <i class="fas fa-list me-2"></i>Danh sách
                        </label>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>Bộ lọc
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterGiangVien" class="form-label">Giảng viên:</label>
                        <select class="form-select" id="filterGiangVien">
                            <option value="">Tất cả giảng viên</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterPhongHoc" class="form-label">Phòng học:</label>
                        <select class="form-select" id="filterPhongHoc">
                            <option value="">Tất cả phòng học</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterThu" class="form-label">Thứ:</label>
                        <select class="form-select" id="filterThu">
                            <option value="">Tất cả</option>
                            <option value="2">Thứ 2</option>
                            <option value="3">Thứ 3</option>
                            <option value="4">Thứ 4</option>
                            <option value="5">Thứ 5</option>
                            <option value="6">Thứ 6</option>
                            <option value="7">Thứ 7</option>
                            <option value="8">Chủ nhật</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterMonHoc" class="form-label">Môn học:</label>
                        <select class="form-select" id="filterMonHoc">
                            <option value="">Tất cả môn học</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filterKhoa" class="form-label">Khoa:</label>
                        <select class="form-select" id="filterKhoa">
                            <option value="">Tất cả khoa</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên môn học, mã lớp học phần, giảng viên...">
                    </div>
                    <div class="col-md-8">
                        <div class="d-flex gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showConflictsOnly">
                                <label class="form-check-label" for="showConflictsOnly">
                                    Chỉ hiển thị lịch có trùng
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showActiveOnly" checked>
                                <label class="form-check-label" for="showActiveOnly">
                                    Chỉ hiển thị lịch đang hoạt động
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="groupByTeacher">
                                <label class="form-check-label" for="groupByTeacher">
                                    Nhóm theo giảng viên
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendarViewContainer" class="schedule-calendar">
                <div class="calendar-header">
                    <h4 class="mb-0">
                        <span id="currentWeekTitle "><p class="text-white">Lịch học tuần</p></span>
                        <p class="text-white"><small class="ms-2" id="weekDateRange"></small></p>
                    </h4>
                    <div class="calendar-controls">
                        <div class="btn-group me-3">
                            <button class="btn btn-light btn-sm" onclick="showSemesterView()">
                                <i class="fas fa-calendar-alt me-1"></i>Cả học kỳ
                            </button>
                            <button class="btn btn-light btn-sm" onclick="showMonthView()">
                                <i class="fas fa-calendar me-1"></i>Tháng
                            </button>
                            <button class="btn btn-light btn-sm active" onclick="showWeekView()">
                                <i class="fas fa-calendar-week me-1"></i>Tuần
                            </button>
                        </div>
                        <button class="btn btn-light btn-sm me-2" onclick="previousWeek()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-light btn-sm me-2" onclick="currentWeek()">
                            Tuần hiện tại
                        </button>
                        <button class="btn btn-light btn-sm" onclick="nextWeek()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex">
                    <!-- Time Column -->
                    <div class="time-column">
                        <div class="day-header">Tiết học</div>
                        <div id="timeSlots"></div>
                    </div>
                    <!-- Days Columns -->
                    <div class="flex-grow-1 d-flex">
                        <div class="day-column" data-day="2">
                            <div class="day-header">Thứ 2</div>
                            <div class="day-content" id="day-2"></div>
                        </div>
                        <div class="day-column" data-day="3">
                            <div class="day-header">Thứ 3</div>
                            <div class="day-content" id="day-3"></div>
                        </div>
                        <div class="day-column" data-day="4">
                            <div class="day-header">Thứ 4</div>
                            <div class="day-content" id="day-4"></div>
                        </div>
                        <div class="day-column" data-day="5">
                            <div class="day-header">Thứ 5</div>
                            <div class="day-content" id="day-5"></div>
                        </div>
                        <div class="day-column" data-day="6">
                            <div class="day-header">Thứ 6</div>
                            <div class="day-content" id="day-6"></div>
                        </div>
                        <div class="day-column" data-day="7">
                            <div class="day-header">Thứ 7</div>
                            <div class="day-content" id="day-7"></div>
                        </div>
                        <div class="day-column" data-day="8">
                            <div class="day-header">Chủ nhật</div>
                            <div class="day-content" id="day-8"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid View -->
            <div id="gridViewContainer" class="schedule-calendar" style="display: none;">
                <div class="calendar-header">
                    <h4 class="mb-1">Lưới lịch học</h4>
                </div>
                <div id="scheduleGrid" class="schedule-grid">
                    <!-- Grid will be populated by JavaScript -->
                </div>
            </div>

            <!-- List View -->
            <div id="listViewContainer" class="admin-table-wrapper" style="display: none;">
                <div class="admin-table-header">
                    <h5 class="admin-table-title">
                        <i class="fas fa-list me-2"></i>Danh sách lịch học
                    </h5>
                    <div class="table-actions">
                        <button class="btn btn-success btn-sm me-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Làm mới
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>Xuất Excel
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table admin-table list-view-table">
                        <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>Mã lịch</th>
                            <th>Môn học</th>
                            <th>Lớp HP</th>
                            <th>Giảng viên</th>
                            <th>Phòng học</th>
                            <th>Thứ</th>
                            <th>Tiết</th>
                            <th>Thời gian</th>
                            <th>Học kỳ</th>
                            <th>Trạng thái</th>
                            <th width="120">Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                        <tr>
                            <td colspan="12" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="text-muted">Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> trong tổng số <span id="totalRecords">0</span> bản ghi</span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Pagination will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Tạo/Sửa Lịch học -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-calendar-plus me-2"></i>Tạo lịch học
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <input type="hidden" id="scheduleId">

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>Thông tin cơ bản
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maLich" class="form-label">Mã lịch học <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="maLich" required>
                                <div class="form-text">Mã lịch sẽ được tự động tạo nếu để trống</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maLhp" class="form-label">Lớp học phần <span class="text-danger">*</span></label>
                                <select class="form-select" id="maLhp" required>
                                    <option value="">Chọn lớp học phần</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Information -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-clock me-2"></i>Thông tin lịch học
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="thu" class="form-label">Thứ <span class="text-danger">*</span></label>
                                <select class="form-select" id="thu" required>
                                    <option value="">Chọn thứ</option>
                                    <option value="2">Thứ 2</option>
                                    <option value="3">Thứ 3</option>
                                    <option value="4">Thứ 4</option>
                                    <option value="5">Thứ 5</option>
                                    <option value="6">Thứ 6</option>
                                    <option value="7">Thứ 7</option>
                                    <option value="8">Chủ nhật</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="tietBatDau" class="form-label">Tiết bắt đầu <span class="text-danger">*</span></label>
                                <select class="form-select" id="tietBatDau" required>
                                    <option value="">Chọn tiết</option>
                                    <option value="1">Tiết 1 (07:00-07:50)</option>
                                    <option value="2">Tiết 2 (07:50-08:40)</option>
                                    <option value="3">Tiết 3 (08:50-09:40)</option>
                                    <option value="4">Tiết 4 (09:50-10:40)</option>
                                    <option value="5">Tiết 5 (10:40-11:30)</option>
                                    <option value="6">Tiết 6 (13:00-13:50)</option>
                                    <option value="7">Tiết 7 (13:50-14:40)</option>
                                    <option value="8">Tiết 8 (14:50-15:40)</option>
                                    <option value="9">Tiết 9 (15:50-16:40)</option>
                                    <option value="10">Tiết 10 (16:40-17:30)</option>
                                    <option value="11">Tiết 11 (18:15-19:05)</option>
                                    <option value="12">Tiết 12 (19:05-19:55)</option>
                                    <option value="13">Tiết 13 (20:05-20:55)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="soTiet" class="form-label">Số tiết <span class="text-danger">*</span></label>
                                <select class="form-select" id="soTiet" required>
                                    <option value="">Chọn số tiết</option>
                                    <option value="1">1 tiết (45 phút)</option>
                                    <option value="2">2 tiết (90 phút)</option>
                                    <option value="3">3 tiết (135 phút)</option>
                                    <option value="4">4 tiết (180 phút)</option>
                                    <option value="5">5 tiết (225 phút)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maPhong" class="form-label">Phòng học <span class="text-danger">*</span></label>
                                <select class="form-select" id="maPhong" required>
                                    <option value="">Chọn phòng học</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Phòng học sẽ được kiểm tra tự động về tình trạng trống
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Thời gian kết thúc</label>
                                <input type="text" class="form-control" id="thoiGianKetThuc" readonly>
                                <div class="form-text">Được tính tự động dựa trên tiết bắt đầu và số tiết</div>
                            </div>
                        </div>
                    </div>

                    <!-- Room Availability -->
                    <div id="roomAvailability" class="mb-3" style="display: none;">
                        <h6 class="text-info">
                            <i class="fas fa-door-open me-2"></i>Tình trạng phòng học
                        </h6>
                        <div id="roomAvailabilityContent"></div>
                    </div>

                    <!-- Conflict Check Section -->
                    <div id="conflictCheckSection" style="display: none;">
                        <div class="conflict-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Phát hiện trùng lịch!</h6>
                            <div id="conflictDetails"></div>
                        </div>
                    </div>

                    <!-- Auto Check -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoCheckConflicts" checked>
                        <label class="form-check-label" for="autoCheckConflicts">
                            Tự động kiểm tra trùng lịch khi thay đổi thông tin
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-warning" onclick="checkConflictsBeforeSave()">
                    <i class="fas fa-search me-2"></i>Kiểm tra trùng lịch
                </button>
                <button type="button" class="btn btn-info" onclick="suggestAlternativeRooms()">
                    <i class="fas fa-lightbulb me-2"></i>Gợi ý phòng khác
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <span class="btn-text">
                        <i class="fas fa-save me-2"></i>Lưu
                    </span>
                    <div class="spinner-border spinner-border-sm d-none ms-2" role="status"></div>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sắp lịch học kỳ -->
<div class="modal fade" id="semesterScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus me-2"></i>Sắp lịch học kỳ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Semester Selection -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="semesterScheduleSelect" class="form-label">Học kỳ <span class="text-danger">*</span></label>
                        <select class="form-select" id="semesterScheduleSelect" required>
                            <option value="">Chọn học kỳ</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="yearScheduleSelect" class="form-label">Năm học <span class="text-danger">*</span></label>
                        <select class="form-select" id="yearScheduleSelect" required>
                            <option value="">Chọn năm học</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-primary" onclick="loadSemesterClasses()">
                                <i class="fas fa-search me-2"></i>Tải lớp học phần
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Schedule Configuration -->
                <div id="scheduleConfiguration" style="display: none;">
                    <div class="schedule-summary">
                        <h6><i class="fas fa-info-circle me-2"></i>Thông tin học kỳ</h6>
                        <div id="semesterSummary"></div>
                    </div>

                    <!-- Auto Schedule Options -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>Tùy chọn sắp lịch tự động</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="avoidConflicts" checked>
                                        <label class="form-check-label" for="avoidConflicts">
                                            Tránh trùng lịch
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optimizeRooms" checked>
                                        <label class="form-check-label" for="optimizeRooms">
                                            Tối ưu phòng học
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="balanceWorkload">
                                        <label class="form-check-label" for="balanceWorkload">
                                            Cân bằng khối lượng
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="preferMorning">
                                        <label class="form-check-label" for="preferMorning">
                                            Ưu tiên buổi sáng
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classes List -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAllClasses" onchange="toggleSelectAllClasses()">
                                </th>
                                <th>Mã LHP</th>
                                <th>Môn học</th>
                                <th>Giảng viên</th>
                                <th>Số tiết/tuần</th>
                                <th>Số SV</th>
                                <th>Trạng thái lịch</th>
                                <th>Thao tác</th>
                            </tr>
                            </thead>
                            <tbody id="semesterClassesBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Đóng
                </button>
                <button type="button" class="btn btn-warning" onclick="previewSchedule()" disabled id="previewBtn">
                    <i class="fas fa-eye me-2"></i>Xem trước
                </button>
                <button type="button" class="btn btn-success" onclick="autoGenerateSchedule()" disabled id="generateBtn">
                    <i class="fas fa-magic me-2"></i>Tự động sắp lịch
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSemesterSchedule()" disabled id="saveSemesterBtn">
                    <i class="fas fa-save me-2"></i>Lưu lịch học kỳ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chi tiết lịch học -->
<div class="modal fade" id="scheduleDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Chi tiết lịch học
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="scheduleDetailContent">
                <!-- Content will be populated by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Đóng
                </button>
                <button type="button" class="btn btn-warning" onclick="duplicateSchedule()">
                    <i class="fas fa-copy me-2"></i>Nhân bản
                </button>
                <button type="button" class="btn btn-primary" onclick="editFromDetail()">
                    <i class="fas fa-edit me-2"></i>Chỉnh sửa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chuyển phòng hàng loạt -->
<div class="modal fade" id="moveRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Chuyển phòng học
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Số lịch học được chọn: <span id="selectedCount" class="badge bg-primary">0</span></label>
                </div>
                <div class="mb-3">
                    <label for="newRoom" class="form-label">Phòng học mới <span class="text-danger">*</span></label>
                    <select class="form-select" id="newRoom" required>
                        <option value="">Chọn phòng học mới</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkNewRoomConflicts" checked>
                        <label class="form-check-label" for="checkNewRoomConflicts">
                            Kiểm tra trùng lịch với phòng mới
                        </label>
                    </div>
                </div>
                <div id="moveConflictWarning" style="display: none;">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Cảnh báo</h6>
                        <div id="moveConflictDetails"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" onclick="checkMoveConflicts()">
                    <i class="fas fa-search me-2"></i>Kiểm tra trùng lịch
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmMoveRooms()">
                    <i class="fas fa-exchange-alt me-2"></i>Chuyển phòng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="loading-content">
        <div class="loading-spinner-circle"></div>
        <h5 style="color: #495057; margin-bottom: 0.5rem;">Đang xử lý...</h5>
        <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">Vui lòng đợi trong giây lát</p>
        <!-- Hoặc sử dụng loading dots -->
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/sidebar.js}"></script>

<script>
        // ========================================
        // CONSTANTS AND CONFIGURATION
        // ========================================
        const API_BASE = '/api';
        const ITEMS_PER_PAGE = 20;

        // Time slots configuration
        const TIME_SLOTS = [
            { tiet: 1, time: '07:00-07:50', start: '07:00', end: '07:50' },
            { tiet: 2, time: '07:50-08:40', start: '07:50', end: '08:40' },
            { tiet: 3, time: '08:50-09:40', start: '08:50', end: '09:40' },
            { tiet: 4, time: '09:50-10:40', start: '09:50', end: '10:40' },
            { tiet: 5, time: '10:40-11:30', start: '10:40', end: '11:30' },
            { tiet: 6, time: '13:00-13:50', start: '13:00', end: '13:50' },
            { tiet: 7, time: '13:50-14:40', start: '13:50', end: '14:40' },
            { tiet: 8, time: '14:50-15:40', start: '14:50', end: '15:40' },
            { tiet: 9, time: '15:50-16:40', start: '15:50', end: '16:40' },
            { tiet: 10, time: '16:40-17:30', start: '16:40', end: '17:30' },
            { tiet: 11, time: '18:15-19:05', start: '18:15', end: '19:05' },
            { tiet: 12, time: '19:05-19:55', start: '19:05', end: '19:55' },
            { tiet: 13, time: '20:05-20:55', start: '20:05', end: '20:55' }
        ];

        // ========================================
        // GLOBAL STATE
        // ========================================
        let globalState = {
            // Data
            scheduleData: [],
            lopHocPhanData: [],
            phongHocData: [],
            giangVienData: [],
            semesterData: [],
            yearData: [],
            khoaData: [],
            monHocData: [],

            // Filtered and paginated data
            filteredData: [],
            currentPage: 1,
            totalPages: 1,

            // UI State
            currentViewMode: 'calendar',
            currentScheduleId: null,
            selectedSchedules: new Set(),
            currentSemester: null,
            currentYear: null,

            // Loading states
            isLoading: false,
            isInitialized: false,

            // Auto-refresh
            refreshInterval: null,
            lastRefresh: null
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();

        });

        async function initializePage() {
            console.log('🚀 Initializing LichHoc page...');
            showLoading(true);

            try {
                // Setup event listeners first
                setupEventListeners();

                // Initialize calendar state
                initializeCalendarState();

                // Load all required data
                await Promise.all([
                    loadScheduleData(),
                    loadLopHocPhanData(),
                    loadPhongHocData(),
                    loadGiangVienData(),
                    loadSemesterData(),
                    loadYearData(),
                    loadKhoaData(),
                    loadMonHocData()
                ]);

                // Enrich data after all loaded
                await enrichLopHocPhanData();

                // Initialize UI components
                initializeUI();

                // Load current semester
                await loadCurrentSemester();

                // Initial render
                await refreshDisplay();

                // Setup auto-refresh
                setupAutoRefresh();

                globalState.isInitialized = true;
                console.log('✅ Page initialized successfully');

            } catch (error) {
                console.error('❌ Error initializing page:', error);
                showNotification('Lỗi khi khởi tạo trang: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function setupEventListeners() {
            // Ẩn tất cả dropdown khi mở modal chi tiết
            $(document).on('show.bs.modal', '#scheduleDetailModal', function() {
                // Đóng tất cả Select2 dropdown
                $('.select2-dropdown').hide();
                $('.select2-container--open').removeClass('select2-container--open');

                // Đặt z-index cao
                $(this).css('z-index', 1065);
            });

            // Reset z-index khi đóng modal chi tiết
            $(document).on('hidden.bs.modal', '#scheduleDetailModal', function() {
                $(this).css('z-index', '');
            });

            // View mode toggle
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    globalState.currentViewMode = this.id.replace('View', '');
                    toggleView();
                });
            });

            // Semester and year selectors
            document.getElementById('semesterSelect').addEventListener('change', onSemesterChange);
            document.getElementById('yearSelect').addEventListener('change', onYearChange);

            // Filters
            document.getElementById('filterGiangVien').addEventListener('change', filterData);
            document.getElementById('filterPhongHoc').addEventListener('change', filterData);
            document.getElementById('filterThu').addEventListener('change', filterData);
            document.getElementById('filterMonHoc').addEventListener('change', filterData);
            document.getElementById('filterKhoa').addEventListener('change', filterData);
            document.getElementById('searchInput').addEventListener('input', debounce(filterData, 300));
            document.getElementById('showConflictsOnly').addEventListener('change', filterData);
            document.getElementById('showActiveOnly').addEventListener('change', filterData);
            document.getElementById('groupByTeacher').addEventListener('change', filterData);

            // Modal form fields with auto-conflict checking
            const formFields = ['thu', 'tietBatDau', 'soTiet', 'maPhong', 'maLhp'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('change', onFormFieldChange);
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function initializeUI() {
            // Initialize Select2 cho filter dropdowns với z-index thấp
            safeSelect2Init('#filterGiangVien, #filterPhongHoc, #filterMonHoc, #filterKhoa', {
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $(document.body),
                dropdownCssClass: 'filter-dropdown'
            });

            // Initialize Select2 cho modal dropdowns với z-index cao hơn
            safeSelect2Init('#maLhp, #maPhong', {
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $(document.body)
            });

            // Setup time slots
            setupTimeSlots();

            // Populate all dropdowns
            populateAllDropdowns();

            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // ========================================
        // DATA LOADING FUNCTIONS
        // ========================================
        async function loadScheduleData() {
            try {
                const response = await apiCall('/lichhoc');
                globalState.scheduleData = Array.isArray(response) ? response : [];
                globalState.filteredData = [...globalState.scheduleData];
                console.log('✅ Schedule data loaded:', globalState.scheduleData.length);
            } catch (error) {
                console.error('❌ Error loading schedules:', error);
                globalState.scheduleData = [];
                globalState.filteredData = [];
            }
        }

        async function loadLopHocPhanData() {
            try {
                const response = await apiCall('/lophocphan');
                let lopHocPhanData = Array.isArray(response) ? response : [];

                // Load thêm thông tin số sinh viên cho từng lớp học phần
                for (let lhp of lopHocPhanData) {
                    try {
                        // Gọi API để lấy số sinh viên đã đăng ký
                        const studentResponse = await apiCall(`/lophocphan/${lhp.maLhp}/sinhvien`);
                        lhp.soSinhVien = Array.isArray(studentResponse) ? studentResponse.length : 0;
                    } catch (error) {
                        console.warn(`Không thể tải số sinh viên cho LHP ${lhp.maLhp}:`, error);
                        lhp.soSinhVien = 0;
                    }
                }

                globalState.lopHocPhanData = lopHocPhanData;
                console.log('✅ LHP data loaded with student count:', globalState.lopHocPhanData.length);
            } catch (error) {
                console.error('❌ Error loading LHP:', error);
                globalState.lopHocPhanData = [];
            }
        }

        async function loadPhongHocData() {
            try {
                console.log('📡 Loading phòng học data...');

                // Sử dụng endpoint /all để lấy tất cả phòng học active
                const response = await apiCall('/phonghoc/all');

                if (Array.isArray(response)) {
                    // Filter chỉ lấy phòng học active và khả dụng
                    globalState.phongHocData = response.filter(room => {
                        return room.isActive !== false && room.trangThai !== 'INACTIVE';
                    });
                } else {
                    console.warn('⚠️ API response is not an array:', response);
                    globalState.phongHocData = [];
                }

                console.log(`✅ Phòng học data loaded: ${globalState.phongHocData.length} rooms`);

                // Populate dropdown ngay sau khi load xong
                populatePhongHocDropdowns();

            } catch (error) {
                console.error('❌ Error loading phòng học:', error);
                globalState.phongHocData = [];

                // Vẫn gọi populate để hiển thị thông báo lỗi
                populatePhongHocDropdowns();

                // Hiển thị thông báo lỗi cho user
                if (typeof showNotification === 'function') {
                    showNotification('Không thể tải danh sách phòng học. Vui lòng thử lại.', 'error');
                }
            }
        }

        // Hàm alternative nếu endpoint /all không work
        async function loadPhongHocDataAlternative() {
            try {
                console.log('📡 Loading phòng học data (alternative method)...');

                // Thử endpoint pagination với size lớn
                const response = await apiCall('/phonghoc?page=0&size=1000');

                if (response && response.content && Array.isArray(response.content)) {
                    globalState.phongHocData = response.content.filter(room => {
                        return room.isActive !== false && room.trangThai !== 'INACTIVE';
                    });
                } else {
                    throw new Error('Invalid response format');
                }

                console.log(`✅ Phòng học data loaded (alternative): ${globalState.phongHocData.length} rooms`);
                populatePhongHocDropdowns();

            } catch (error) {
                console.error('❌ Error loading phòng học (alternative):', error);
                globalState.phongHocData = [];
                populatePhongHocDropdowns();
            }
        }

        // Hàm khởi tạo - gọi trong DOMContentLoaded
        async function initializePhongHocDropdown() {
            console.log('🚀 Initializing phòng học dropdown...');

            // Thử method chính trước
            await loadPhongHocData();

            // Nếu không có dữ liệu, thử method alternative
            if (globalState.phongHocData.length === 0) {
                console.log('🔄 Trying alternative method...');
                await loadPhongHocDataAlternative();
            }
        }


        // Hàm populate dropdown phòng học - đã sửa
        function populatePhongHocDropdowns() {
            const selectors = ['#maPhong', '#filterPhongHoc'];

            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (!element) {
                    console.warn(`⚠️ Element not found: ${selector}`);
                    return;
                }

                // Lưu giá trị hiện tại
                const currentValue = element.value;

                // Xác định text mặc định
                const isFilter = selector.includes('filter');
                const defaultText = isFilter ? 'Tất cả phòng học' : 'Chọn phòng học';

                // Clear và thêm option mặc định
                element.innerHTML = `<option value="">${defaultText}</option>`;

                if (globalState.phongHocData && globalState.phongHocData.length > 0) {
                    // Thêm các option phòng học
                    globalState.phongHocData.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.maPhong;

                        // Format text hiển thị: "Tên phòng (Mã phòng) - Loại phòng"
                        let displayText = room.tenPhong || room.maPhong;
                        if (room.maPhong && room.tenPhong !== room.maPhong) {
                            displayText += ` (${room.maPhong})`;
                        }
                        if (room.loaiPhongDisplay) {
                            displayText += ` - ${room.loaiPhongDisplay}`;
                        } else if (room.loaiPhong) {
                            displayText += ` - ${room.loaiPhong}`;
                        }

                        // Thêm trạng thái nếu không phải AVAILABLE
                        if (room.trangThaiDisplay && room.trangThai !== 'AVAILABLE') {
                            displayText += ` [${room.trangThaiDisplay}]`;
                        }

                        option.textContent = displayText;

                        // Disable option nếu phòng đang bảo trì
                        if (room.trangThai === 'MAINTENANCE') {
                            option.disabled = true;
                            option.style.color = '#999';
                        }

                        element.appendChild(option);
                    });

                    // Khôi phục giá trị cũ nếu còn hợp lệ
                    if (currentValue && globalState.phongHocData.some(room => room.maPhong === currentValue)) {
                        element.value = currentValue;
                    }

                } else {
                    // Không có dữ liệu hoặc có lỗi
                    const noDataOption = document.createElement('option');
                    noDataOption.value = '';
                    noDataOption.textContent = 'Không có phòng học khả dụng';
                    noDataOption.disabled = true;
                    noDataOption.style.color = '#dc3545';
                    element.appendChild(noDataOption);
                }
            });

            console.log(`✅ Populated ${selectors.length} phòng học dropdowns`);
        }

        async function loadGiangVienData() {
            try {
                const response = await apiCall('/giangvien');
                globalState.giangVienData = Array.isArray(response) ? response.filter(g => g.isActive !== false) : [];
                console.log('✅ Teacher data loaded:', globalState.giangVienData.length);
            } catch (error) {
                console.error('❌ Error loading teachers:', error);
                globalState.giangVienData = [];
            }
        }

        async function loadSemesterData() {
            try {
                const response = await apiCall('/hocky');
                globalState.semesterData = Array.isArray(response) ? response.filter(s => s.isActive !== false) : [];
                console.log('✅ Semester data loaded:', globalState.semesterData.length);
            } catch (error) {
                console.error('❌ Error loading semesters:', error);
                globalState.semesterData = [];
            }
        }

        async function loadYearData() {
            try {
                const response = await apiCall('/namhoc');
                globalState.yearData = Array.isArray(response) ? response.filter(y => y.isActive !== false) : [];
                console.log('✅ Year data loaded:', globalState.yearData.length);
            } catch (error) {
                console.error('❌ Error loading years:', error);
                globalState.yearData = [];
            }
        }

        async function loadKhoaData() {
            try {
                const response = await apiCall('/khoa');
                globalState.khoaData = Array.isArray(response) ? response.filter(k => k.isActive !== false) : [];
                console.log('✅ Faculty data loaded:', globalState.khoaData.length);
            } catch (error) {
                console.error('❌ Error loading faculties:', error);
                globalState.khoaData = [];
            }
        }

        async function loadMonHocData() {
            try {
                const response = await apiCall('/monhoc');
                globalState.monHocData = Array.isArray(response) ? response.filter(m => m.isActive !== false) : [];
                console.log('✅ Subject data loaded:', globalState.monHocData.length);
            } catch (error) {
                console.error('❌ Error loading subjects:', error);
                globalState.monHocData = [];
            }
        }

        async function loadCurrentSemester() {
            try {
                const response = await apiCall('/lichhoc/current-semester');
                if (response && response.length > 0) {
                    // Find current semester info from the first schedule
                    const firstSchedule = response[0];
                    if (firstSchedule.hocKy) {
                        globalState.currentSemester = firstSchedule.hocKy;
                        globalState.currentYear = firstSchedule.namHoc;

                        // Update selectors
                        document.getElementById('semesterSelect').value = globalState.currentSemester;
                        document.getElementById('yearSelect').value = globalState.currentYear;

                        // Show semester info
                        showCurrentSemesterInfo();
                    }
                }
            } catch (error) {
                console.warn('No current semester found:', error);
            }
        }

        // ========================================
        // UI POPULATION FUNCTIONS
        // ========================================
        function populateAllDropdowns() {
            populateTeacherDropdowns();
            populateRoomDropdowns();
            populateSemesterDropdowns();
            populateYearDropdowns();
            populateSubjectDropdowns();
            populateFacultyDropdowns();
            populateLHPDropdowns();
        }

        function populateTeacherDropdowns() {
            const selectors = ['#filterGiangVien'];
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    element.innerHTML = '<option value="">Tất cả giảng viên</option>';
                    globalState.giangVienData.forEach(teacher => {
                        element.innerHTML += `<option value="${teacher.maGv}">${teacher.hoTen} (${teacher.maGv})</option>`;
                    });
                }
            });
        }

        function populateRoomDropdowns() {
            const selectors = ['#filterPhongHoc', '#maPhong', '#newRoom'];
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    const defaultText = selector === '#filterPhongHoc' ? 'Tất cả phòng học' : 'Chọn phòng học';
                    element.innerHTML = `<option value="">${defaultText}</option>`;
                    globalState.phongHocData.forEach(room => {
                        element.innerHTML += `<option value="${room.maPhong}">${room.tenPhong} (${room.maPhong}) - ${room.loaiPhong || 'Phòng học'}</option>`;
                    });
                }
            });
        }

        function populateSemesterDropdowns() {
            const selectors = ['#semesterSelect', '#filterSemester', '#semesterScheduleSelect'];
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    const defaultText = selector === '#semesterSelect' ? 'Tất cả học kỳ' : 'Chọn học kỳ';
                    element.innerHTML = `<option value="">${defaultText}</option>`;
                    globalState.semesterData.forEach(semester => {
                        const isCurrentClass = semester.isCurrent ? ' (Hiện tại)' : '';
                        element.innerHTML += `<option value="${semester.maHocKy}">${semester.tenHocKy}${isCurrentClass}</option>`;
                    });
                }
            });
        }

        function populateYearDropdowns() {
            const selectors = ['#yearSelect', '#filterYear', '#yearScheduleSelect'];
            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    const defaultText = selector === '#yearSelect' ? 'Tất cả năm học' : 'Chọn năm học';
                    element.innerHTML = `<option value="">${defaultText}</option>`;
                    globalState.yearData.forEach(year => {
                        const isCurrentClass = year.isCurrent ? ' (Hiện tại)' : '';
                        element.innerHTML += `<option value="${year.maNamHoc}">${year.tenNamHoc}${isCurrentClass}</option>`;
                    });
                }
            });
        }

        function populateSubjectDropdowns() {
            const element = document.querySelector('#filterMonHoc');
            if (element) {
                element.innerHTML = '<option value="">Tất cả môn học</option>';
                globalState.monHocData.forEach(subject => {
                    element.innerHTML += `<option value="${subject.maMh}">${subject.tenMh} (${subject.maMh})</option>`;
                });
            }
        }

        function populateFacultyDropdowns() {
            const element = document.querySelector('#filterKhoa');
            if (element) {
                element.innerHTML = '<option value="">Tất cả khoa</option>';
                globalState.khoaData.forEach(faculty => {
                    element.innerHTML += `<option value="${faculty.maKhoa}">${faculty.tenKhoa}</option>`;
                });
            }
        }

        function populateLHPDropdowns() {
            const element = document.querySelector('#maLhp');
            if (element) {
                element.innerHTML = '<option value="">Chọn lớp học phần</option>';
                globalState.lopHocPhanData.forEach(lhp => {
                    // Tìm tên môn học từ monHocData
                    const monHoc = globalState.monHocData.find(m => m.maMh === lhp.maMh);
                    const tenMonHoc = monHoc ? monHoc.tenMh : (lhp.tenMonHoc || 'N/A');

                    // Tìm tên giảng viên từ giangVienData
                    const giangVien = globalState.giangVienData.find(g => g.maGv === lhp.maGv);
                    const tenGiangVien = giangVien ? giangVien.hoTen : (lhp.tenGiangVien || 'Chưa phân công');

                    element.innerHTML += `<option value="${lhp.maLhp}">${lhp.maLhp} - ${tenMonHoc} (${tenGiangVien})</option>`;
                });
            }
        }

        function setupTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            if (timeSlotsContainer) {
                timeSlotsContainer.innerHTML = '';
                TIME_SLOTS.forEach(slot => {
                    const timeSlotDiv = document.createElement('div');
                    timeSlotDiv.className = 'time-slot';
                    timeSlotDiv.innerHTML = `
                        <div><strong>Tiết ${slot.tiet}</strong></div>
                        <div>${slot.time}</div>
                    `;
                    timeSlotsContainer.appendChild(timeSlotDiv);
                });
            }
        }

        // ========================================
        // EVENT HANDLERS
        // ========================================
        async function onSemesterChange() {
            const semesterSelect = document.getElementById('semesterSelect');
            globalState.currentSemester = semesterSelect.value;
            await refreshDisplay();
            showCurrentSemesterInfo();
        }

        async function onYearChange() {
            const yearSelect = document.getElementById('yearSelect');
            globalState.currentYear = yearSelect.value;
            await refreshDisplay();
            showCurrentSemesterInfo();
        }

        function onFormFieldChange() {
            // Auto-calculate end time
            calculateEndTime();

            // Auto-check conflicts if enabled
            if (document.getElementById('autoCheckConflicts').checked) {
                debounce(checkConflictsBeforeSave, 500)();
            }

            // Check room availability
            checkRoomAvailability();
        }

        function calculateEndTime() {
            const tietBatDau = parseInt(document.getElementById('tietBatDau').value);
            const soTiet = parseInt(document.getElementById('soTiet').value);

            if (tietBatDau && soTiet) {
                const endTiet = tietBatDau + soTiet - 1;
                const startSlot = TIME_SLOTS.find(slot => slot.tiet === tietBatDau);
                const endSlot = TIME_SLOTS.find(slot => slot.tiet === endTiet);

                if (startSlot && endSlot) {
                    const endTimeText = `${startSlot.start} - ${endSlot.end} (Tiết ${tietBatDau} - ${endTiet})`;
                    document.getElementById('thoiGianKetThuc').value = endTimeText;
                }
            }
        }

        async function checkRoomAvailability() {
            const maPhong = document.getElementById('maPhong').value;
            const thu = document.getElementById('thu').value;
            const tietBatDau = document.getElementById('tietBatDau').value;
            const soTiet = document.getElementById('soTiet').value;

            if (maPhong && thu && tietBatDau && soTiet) {
                try {
                    // Get room schedule for the day
                    const roomSchedules = globalState.scheduleData.filter(schedule =>
                        schedule.maPhong === maPhong &&
                        schedule.thu.toString() === thu &&
                        schedule.isActive !== false
                    );

                    const availabilityContainer = document.getElementById('roomAvailability');
                    const availabilityContent = document.getElementById('roomAvailabilityContent');

                    if (roomSchedules.length > 0) {
                        availabilityContainer.style.display = 'block';
                        availabilityContent.innerHTML = `
                            <div class="alert alert-info">
                                <strong>Lịch sử dụng phòng trong ngày:</strong>
                                <ul class="mb-0 mt-2">
                                    ${roomSchedules.map(schedule => `
                                        <li>Tiết ${schedule.tietBatDau}-${schedule.tietBatDau + schedule.soTiet - 1}: ${schedule.tenMonHoc || 'N/A'} - ${schedule.tenGiangVien || 'N/A'}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    } else {
                        availabilityContainer.style.display = 'block';
                        availabilityContent.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>Phòng học trống trong ngày này
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error checking room availability:', error);
                }
            } else {
                document.getElementById('roomAvailability').style.display = 'none';
            }
        }

        function handleKeyboardShortcuts(e) {
            // Ctrl + N: New schedule
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openCreateModal();
            }

            // Ctrl + R: Refresh
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }

            // Ctrl + F: Focus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Escape: Close modals
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    bootstrap.Modal.getInstance(modal)?.hide();
                });
            }
        }

        // ========================================
        // DISPLAY AND RENDERING FUNCTIONS
        // ========================================
        async function refreshDisplay() {
            showLoading(true);
            try {
                // Apply current filters
                await filterData();

                // Update statistics
                updateStatistics();

                // Render current view
                renderCurrentView();

                globalState.lastRefresh = new Date();
            } catch (error) {
                console.error('Error refreshing display:', error);
                showNotification('Lỗi khi làm mới dữ liệu', 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleView() {
            const calendarView = document.getElementById('calendarViewContainer');
            const gridView = document.getElementById('gridViewContainer');
            const listView = document.getElementById('listViewContainer');

            // Hide all views
            calendarView.style.display = 'none';
            gridView.style.display = 'none';
            listView.style.display = 'none';

            // Show selected view
            switch (globalState.currentViewMode) {
                case 'calendar':
                    calendarView.style.display = 'block';
                    renderCalendarView();
                    break;
                case 'grid':
                    gridView.style.display = 'block';
                    renderGridView();
                    break;
                case 'list':
                    listView.style.display = 'block';
                    renderListView();
                    break;
            }
        }

        function renderCurrentView() {
            switch (globalState.currentViewMode) {
                case 'calendar':
                    renderCalendarView();
                    break;
                case 'grid':
                    renderGridView();
                    break;
                case 'list':
                    renderListView();
                    break;
            }
        }

        function renderCalendarView() {
            // Clear all day contents
            for (let day = 2; day <= 8; day++) {
                const dayContent = document.getElementById(`day-${day}`);
                if (dayContent) {
                    dayContent.innerHTML = '';
                }
            }

            // Group schedules by teacher if enabled
            const groupByTeacher = document.getElementById('groupByTeacher').checked;
            let schedulesToRender = [...globalState.filteredData];

            if (groupByTeacher) {
                schedulesToRender = groupSchedulesByTeacher(schedulesToRender);
            }

            // Render schedule items
            schedulesToRender.forEach(schedule => {
                renderScheduleItem(schedule);
            });
        }

        function renderScheduleItem(schedule) {
            const dayContent = document.getElementById(`day-${schedule.thu}`);
            if (!dayContent) return;

            const scheduleItem = document.createElement('div');
            scheduleItem.className = 'schedule-item';
            scheduleItem.setAttribute('data-schedule-id', schedule.maLich);

            // Calculate position based on time slot
            const topPosition = (schedule.tietBatDau - 1) * 60 + 5; // 60px per slot + offset
            const height = schedule.soTiet * 60 - 10; // Height based on duration

            scheduleItem.style.top = `${topPosition}px`;
            scheduleItem.style.height = `${height}px`;

            // Check for conflicts
            const conflicts = checkScheduleConflicts(schedule);
            if (conflicts.length > 0) {
                scheduleItem.classList.add('conflict');
            }

            // Check if selected
            if (globalState.selectedSchedules.has(schedule.maLich)) {
                scheduleItem.classList.add('selected');
            }

            scheduleItem.innerHTML = `
                <div class="title">${schedule.tenMonHoc || 'N/A'}</div>
                <div class="info">
                    <div><i class="fas fa-user me-1"></i>${schedule.tenGiangVien || 'N/A'}</div>
                    <div><i class="fas fa-door-open me-1"></i>${schedule.tenPhong || schedule.maPhong}</div>
                    <div><i class="fas fa-users me-1"></i>Nhóm ${schedule.nhom || 'N/A'}</div>
                    <div><i class="fas fa-graduation-cap me-1"></i>${schedule.hocKy || 'N/A'}</div>
                    ${conflicts.length > 0 ? '<span class="conflict-badge">Trùng lịch</span>' : ''}
                </div>
            `;

            // Event listeners
            scheduleItem.addEventListener('click', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    toggleScheduleSelection(schedule.maLich);
                } else {
                    showScheduleDetail(schedule.maLich);
                }
            });

            scheduleItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showScheduleContextMenu(e, schedule);
            });

            dayContent.appendChild(scheduleItem);
        }

        function renderGridView() {
            const gridContainer = document.getElementById('scheduleGrid');
            if (!gridContainer) return;

            // Clear existing grid
            gridContainer.innerHTML = '';

            // Create header row
            const headerRow = ['Tiết', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
            headerRow.forEach((header, index) => {
                const headerCell = document.createElement('div');
                headerCell.className = index === 0 ? 'time-grid-slot' : 'day-grid-header';
                headerCell.textContent = header;
                gridContainer.appendChild(headerCell);
            });

            // Create time slots and schedule cells
            TIME_SLOTS.forEach(slot => {
                // Time slot cell
                const timeCell = document.createElement('div');
                timeCell.className = 'time-grid-slot';
                timeCell.innerHTML = `<div><strong>Tiết ${slot.tiet}: </strong></div><div>${slot.time}</div>`;
                gridContainer.appendChild(timeCell);

                // Day cells
                for (let day = 2; day <= 8; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'grid-cell';
                    dayCell.setAttribute('data-day', day);
                    dayCell.setAttribute('data-tiet', slot.tiet);

                    // Find schedules for this time slot
                    const schedules = globalState.filteredData.filter(schedule =>
                        schedule.thu === day &&
                        schedule.tietBatDau <= slot.tiet &&
                        schedule.tietBatDau + schedule.soTiet > slot.tiet
                    );

                    if (schedules.length > 0) {
                        const schedule = schedules[0]; // Take first if multiple
                        const conflicts = checkScheduleConflicts(schedule);

                        dayCell.innerHTML = `
                            <div class="schedule-grid-item ${conflicts.length > 0 ? 'conflict' : ''}"
                                 data-schedule-id="${schedule.maLich}"
                                 onclick="showScheduleDetail('${schedule.maLich}')">
                                <div class="grid-schedule-title">${schedule.tenMonHoc || 'N/A'}</div>
                                <div class="grid-schedule-info">${schedule.tenGiangVien || 'N/A'}</div>
                                <div class="grid-schedule-room">${schedule.tenPhong || schedule.maPhong}</div>
                            </div>
                        `;

                        if (conflicts.length > 0) {
                            dayCell.classList.add('has-conflict');
                        }
                    }

                    gridContainer.appendChild(dayCell);
                }
            });
        }

        function renderListView() {
            const tbody = document.getElementById('scheduleTableBody');
            if (!tbody) return;

            if (globalState.filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Không có lịch học nào phù hợp với bộ lọc</p>
                        </td>
                    </tr>
                `;
                updatePagination(0);
                return;
            }

            // Calculate pagination
            const startIndex = (globalState.currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, globalState.filteredData.length);
            const pageData = globalState.filteredData.slice(startIndex, endIndex);

            tbody.innerHTML = pageData.map(schedule => {
                const conflicts = checkScheduleConflicts(schedule);
                const timeSlot = TIME_SLOTS.find(t => t.tiet === schedule.tietBatDau);
                const endTiet = schedule.tietBatDau + schedule.soTiet - 1;
                const isSelected = globalState.selectedSchedules.has(schedule.maLich);

                return `
                    <tr class="schedule-row ${isSelected ? 'table-primary' : ''}"
                        onclick="handleRowClick(event, '${schedule.maLich}')">
                        <td>
                            <input type="checkbox" class="schedule-checkbox"
                                   value="${schedule.maLich}"
                                   ${isSelected ? 'checked' : ''}
                                   onclick="event.stopPropagation(); toggleScheduleSelection('${schedule.maLich}')">
                        </td>
                        <td>
                            <strong class="text-primary">${schedule.maLich}</strong>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-medium">${schedule.tenMonHoc || 'N/A'}</span>
                                <small class="text-muted">${schedule.maMh || 'N/A'}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">${schedule.maLhp}</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-medium">${schedule.tenGiangVien || 'N/A'}</span>
                                <small class="text-muted">${schedule.maGv || 'N/A'}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">${schedule.tenPhong || schedule.maPhong}</span>
                        </td>
                        <td>
                            <span class="badge bg-primary">${getDayName(schedule.thu)}</span>
                        </td>
                        <td class="time-cell">
                            Tiết ${schedule.tietBatDau} - ${endTiet}
                        </td>
                        <td class="time-cell">
                            ${timeSlot ? timeSlot.time : 'N/A'}
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="badge bg-success">${schedule.hocKy || 'N/A'}</span>
                                <small class="text-muted">${schedule.namHoc || 'N/A'}</small>
                            </div>
                        </td>
                        <td>
                            ${conflicts.length > 0 ?
                    '<span class="conflict-indicator"><i class="fas fa-exclamation-triangle me-1"></i>Trùng lịch</span>' :
                    '<span class="text-success"><i class="fas fa-check me-1"></i>Bình thường</span>'
                }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="event.stopPropagation(); showScheduleDetail('${schedule.maLich}')" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" onclick="event.stopPropagation(); editSchedule('${schedule.maLich}')" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="event.stopPropagation(); deleteSchedule('${schedule.maLich}')" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination(globalState.filteredData.length);
            updateSelectionInfo();
        }

        function updatePagination(totalItems) {
            globalState.totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            // Update showing info
            const startIndex = (globalState.currentPage - 1) * ITEMS_PER_PAGE + 1;
            const endIndex = Math.min(globalState.currentPage * ITEMS_PER_PAGE, totalItems);

            document.getElementById('showingFrom').textContent = totalItems > 0 ? startIndex : 0;
            document.getElementById('showingTo').textContent = endIndex;
            document.getElementById('totalRecords').textContent = totalItems;

            // Update pagination controls
            const pagination = document.getElementById('pagination');
            if (!pagination) return;

            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <li class="page-item ${globalState.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${globalState.currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            const startPage = Math.max(1, globalState.currentPage - 2);
            const endPage = Math.min(globalState.totalPages, globalState.currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === globalState.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            if (endPage < globalState.totalPages) {
                if (endPage < globalState.totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${globalState.totalPages})">${globalState.totalPages}</a></li>`;
            }

            // Next button
            paginationHTML += `
                <li class="page-item ${globalState.currentPage === globalState.totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${globalState.currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page < 1 || page > globalState.totalPages) return;
            globalState.currentPage = page;
            renderListView();
        }

        // ========================================
        // FILTERING AND SEARCH
        // ========================================
        async function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const giangVienFilter = document.getElementById('filterGiangVien').value;
            const phongHocFilter = document.getElementById('filterPhongHoc').value;
            const thuFilter = document.getElementById('filterThu').value;
            const monHocFilter = document.getElementById('filterMonHoc').value;
            const khoaFilter = document.getElementById('filterKhoa').value;
            const showConflictsOnly = document.getElementById('showConflictsOnly').checked;
            const showActiveOnly = document.getElementById('showActiveOnly').checked;

            globalState.filteredData = globalState.scheduleData.filter(schedule => {
                // Search filter
                const matchesSearch = !searchTerm || [
                    schedule.tenMonHoc, schedule.maLhp, schedule.tenGiangVien,
                    schedule.tenPhong, schedule.maPhong, schedule.maGv, schedule.maMh, schedule.maLich
                ].some(field => field && field.toString().toLowerCase().includes(searchTerm));

                // Dropdown filters
                const matchesGiangVien = !giangVienFilter || schedule.maGv === giangVienFilter;
                const matchesPhongHoc = !phongHocFilter || schedule.maPhong === phongHocFilter;
                const matchesThu = !thuFilter || schedule.thu.toString() === thuFilter;
                const matchesMonHoc = !monHocFilter || schedule.maMh === monHocFilter;

                // Faculty filter (through subject)
                const matchesKhoa = !khoaFilter || (schedule.maMh &&
                    globalState.monHocData.find(m => m.maMh === schedule.maMh)?.maKhoa === khoaFilter);

                // Semester and year filters
                const matchesSemester = !globalState.currentSemester || schedule.hocKy === globalState.currentSemester;
                const matchesYear = !globalState.currentYear || schedule.namHoc === globalState.currentYear;

                // Active filter
                const matchesActive = !showActiveOnly || schedule.isActive !== false;

                // Conflict filter
                const hasConflict = showConflictsOnly ? checkScheduleConflicts(schedule).length > 0 : true;

                return matchesSearch && matchesGiangVien && matchesPhongHoc &&
                    matchesThu && matchesMonHoc && matchesKhoa &&
                    matchesSemester && matchesYear && matchesActive && hasConflict;
            });

            // Reset to first page
            globalState.currentPage = 1;

            // Update display
            renderCurrentView();
            updateStatistics();
        }

        // ========================================
        // CONFLICT DETECTION
        // ========================================
        function checkScheduleConflicts(schedule) {
            const conflicts = [];

            globalState.scheduleData.forEach(other => {
                if (other.maLich !== schedule.maLich &&
                    other.thu === schedule.thu &&
                    other.isActive !== false) {

                    // Check room conflict
                    if (other.maPhong === schedule.maPhong &&
                        isTimeOverlap(schedule.tietBatDau, schedule.soTiet, other.tietBatDau, other.soTiet)) {
                        conflicts.push({
                            type: 'room',
                            schedule: other,
                            message: `Trùng phòng ${schedule.maPhong} với ${other.tenMonHoc || 'N/A'}`
                        });
                    }

                    // Check teacher conflict
                    if (other.maGv === schedule.maGv &&
                        isTimeOverlap(schedule.tietBatDau, schedule.soTiet, other.tietBatDau, other.soTiet)) {
                        conflicts.push({
                            type: 'teacher',
                            schedule: other,
                            message: `Giảng viên ${schedule.tenGiangVien || 'N/A'} đã có lịch dạy ${other.tenMonHoc || 'N/A'}`
                        });
                    }
                }
            });

            return conflicts;
        }

        function isTimeOverlap(start1, duration1, start2, duration2) {
            const end1 = start1 + duration1 - 1;
            const end2 = start2 + duration2 - 1;
            return !(end1 < start2 || end2 < start1);
        }

        async function checkConflictsBeforeSave() {
            const form = document.getElementById('scheduleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const scheduleData = {
                maLhp: document.getElementById('maLhp').value,
                thu: parseInt(document.getElementById('thu').value),
                tietBatDau: parseInt(document.getElementById('tietBatDau').value),
                soTiet: parseInt(document.getElementById('soTiet').value),
                maPhong: document.getElementById('maPhong').value
            };

            try {
                const response = await apiCall('/lichhoc/check-conflicts', 'POST', scheduleData);
                showConflictWarning(response);
            } catch (error) {
                console.error('Error checking conflicts:', error);
                showNotification('Lỗi khi kiểm tra trùng lịch: ' + error.message, 'error');
            }
        }

        function showConflictWarning(result) {
            const conflictSection = document.getElementById('conflictCheckSection');
            const conflictDetails = document.getElementById('conflictDetails');

            if (result.hasConflict && result.conflictDetails && result.conflictDetails.length > 0) {
                let detailsHtml = '<ul class="mb-0">';
                result.conflictDetails.forEach(conflict => {
                    detailsHtml += `<li>${conflict}</li>`;
                });
                detailsHtml += '</ul>';

                conflictDetails.innerHTML = detailsHtml;
                conflictSection.style.display = 'block';
            } else {
                conflictSection.style.display = 'none';
                if (result.hasConflict === false) {
                    showNotification('Không có trùng lịch!', 'success');
                }
            }
        }

        async function checkAllConflicts() {
            showLoading(true);
            try {
                const conflictingSchedules = [];

                globalState.scheduleData.forEach(schedule => {
                    const conflicts = checkScheduleConflicts(schedule);
                    if (conflicts.length > 0) {
                        conflictingSchedules.push({
                            schedule: schedule,
                            conflicts: conflicts
                        });
                    }
                });

                if (conflictingSchedules.length === 0) {
                    showNotification('Không phát hiện trùng lịch nào!', 'success');
                } else {
                    showNotification(`Phát hiện ${conflictingSchedules.length} lịch học bị trùng. Đã bật bộ lọc để hiển thị.`, 'warning');

                    // Enable conflicts filter
                    document.getElementById('showConflictsOnly').checked = true;
                    await filterData();
                }
            } catch (error) {
                console.error('Error checking all conflicts:', error);
                showNotification('Lỗi khi kiểm tra trùng lịch: ' + error.message, 'error');
            }
        }

        // ========================================
        // MODAL FUNCTIONS
        // ========================================
        function openCreateModal() {
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-calendar-plus me-2"></i>Tạo lịch học';
            document.getElementById('scheduleForm').reset();
            document.getElementById('scheduleId').value = '';
            document.getElementById('conflictCheckSection').style.display = 'none';
            document.getElementById('roomAvailability').style.display = 'none';
            globalState.currentScheduleId = null;

            // Generate auto ID
            generateScheduleId();

            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        }

        function generateScheduleId() {
            const timestamp = Date.now().toString().slice(-6);
            const randomStr = Math.random().toString(36).substring(2, 5).toUpperCase();
            document.getElementById('maLich').value = `LH${timestamp}${randomStr}`;
        }

        function editSchedule(maLich) {
            const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
            if (!schedule) {
                showNotification('Không tìm thấy lịch học', 'error');
                return;
            }

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Sửa lịch học';
            document.getElementById('scheduleId').value = schedule.maLich;
            document.getElementById('maLich').value = schedule.maLich;
            document.getElementById('maLhp').value = schedule.maLhp;
            document.getElementById('thu').value = schedule.thu;
            document.getElementById('tietBatDau').value = schedule.tietBatDau;
            document.getElementById('soTiet').value = schedule.soTiet;
            document.getElementById('maPhong').value = schedule.maPhong;
            document.getElementById('conflictCheckSection').style.display = 'none';
            document.getElementById('roomAvailability').style.display = 'none';

            // Calculate end time
            calculateEndTime();

            globalState.currentScheduleId = maLich;
            const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
            modal.show();
        }

        async function saveSchedule() {
            const form = document.getElementById('scheduleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btnText = document.querySelector('.btn-text');
            const spinner = document.querySelector('.spinner-border');

            btnText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
            spinner.classList.remove('d-none');

            const scheduleDataToSave = {
                maLich: document.getElementById('maLich').value,
                maLhp: document.getElementById('maLhp').value,
                thu: parseInt(document.getElementById('thu').value),
                tietBatDau: parseInt(document.getElementById('tietBatDau').value),
                soTiet: parseInt(document.getElementById('soTiet').value),
                maPhong: document.getElementById('maPhong').value,
                isActive: true
            };

            try {
                const url = globalState.currentScheduleId ?
                    `/lichhoc/${globalState.currentScheduleId}` :
                    '/lichhoc';
                const method = globalState.currentScheduleId ? 'PUT' : 'POST';

                const response = await apiCall(url, method, scheduleDataToSave);

                if (response.success !== false) {
                    showNotification(
                        globalState.currentScheduleId ? 'Cập nhật lịch học thành công!' : 'Tạo lịch học thành công!',
                        'success'
                    );
                    bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
                    await loadScheduleData();
                    await refreshDisplay();
                } else {
                    throw new Error(response.message || 'Lỗi không xác định');
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                showNotification('Lỗi khi lưu: ' + error.message, 'error');
            } finally {
                btnText.innerHTML = '<i class="fas fa-save me-2"></i>Lưu';
                spinner.classList.add('d-none');
            }
        }

        async function deleteSchedule(maLich) {
            if (!confirm('Bạn có chắc chắn muốn xóa lịch học này?')) return;

            try {
                showLoading(true);
                await apiCall(`/lichhoc/${maLich}`, 'DELETE');
                showNotification('Xóa lịch học thành công!', 'success');
                await loadScheduleData();
                await refreshDisplay();
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showNotification('Lỗi khi xóa lịch học: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showScheduleDetail(maLich) {
            // Đóng tất cả Select2 dropdown trước
            $('.select2-dropdown').hide();
            $('.select2-container--open').removeClass('select2-container--open');

            // Đóng tất cả modal khác
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                if (modal.id !== 'scheduleDetailModal') {
                    const instance = bootstrap.Modal.getInstance(modal);
                    if (instance) {
                        instance.hide();
                    }
                }
            });

            const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
            if (!schedule) {
                showNotification('Không tìm thấy lịch học', 'error');
                return;
            }

            const lhp = globalState.lopHocPhanData.find(l => l.maLhp === schedule.maLhp);
            const room = globalState.phongHocData.find(r => r.maPhong === schedule.maPhong);
            const timeSlot = TIME_SLOTS.find(t => t.tiet === schedule.tietBatDau);
            const endTiet = schedule.tietBatDau + schedule.soTiet - 1;
            const conflicts = checkScheduleConflicts(schedule);

            document.getElementById('scheduleDetailContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-id-badge me-2"></i>Thông tin cơ bản</h6>
                <table class="table table-borderless table-sm">
                    <tr><td><strong>Mã lịch:</strong></td><td>${schedule.maLich}</td></tr>
                    <tr><td><strong>Lớp học phần:</strong></td><td>${schedule.maLhp}</td></tr>
                    <tr><td><strong>Môn học:</strong></td><td>${schedule.tenMonHoc || 'N/A'}</td></tr>
                    <tr><td><strong>Mã môn học:</strong></td><td>${schedule.maMh || 'N/A'}</td></tr>
                    <tr><td><strong>Nhóm:</strong></td><td>${schedule.nhom || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-clock me-2"></i>Thời gian & Địa điểm</h6>
                <table class="table table-borderless table-sm">
                    <tr><td><strong>Thứ:</strong></td><td>${getDayName(schedule.thu)}</td></tr>
                    <tr><td><strong>Tiết:</strong></td><td>${schedule.tietBatDau} - ${endTiet}</td></tr>
                    <tr><td><strong>Thời gian:</strong></td><td>${timeSlot ? timeSlot.time : 'N/A'}</td></tr>
                    <tr><td><strong>Phòng học:</strong></td><td>${room ? room.tenPhong : schedule.maPhong}</td></tr>
                    <tr><td><strong>Loại phòng:</strong></td><td>${room ? room.loaiPhong || 'Phòng học' : 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user me-2"></i>Giảng viên</h6>
                <p>${schedule.tenGiangVien || 'N/A'} (${schedule.maGv || 'N/A'})</p>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-graduation-cap me-2"></i>Học kỳ</h6>
                <p>${schedule.hocKy || 'N/A'} - ${schedule.namHoc || 'N/A'}</p>
            </div>
        </div>

        ${conflicts.length > 0 ? `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Cảnh báo trùng lịch</h6>
                <ul class="mb-0">
                    ${conflicts.map(conflict => `<li>${conflict.message}</li>`).join('')}
                </ul>
            </div>
        ` : ''}

        ${lhp ? `
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-info-circle me-2"></i>Thông tin lớp học phần</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Số tín chỉ:</strong> ${lhp.soTinChi || 'N/A'}
                        </div>
                        <div class="col-md-4">
                            <strong>Số sinh viên:</strong> ${lhp.soSinhVien || 'N/A'}
                        </div>
                        <div class="col-md-4">
                            <strong>Trạng thái:</strong>
                            <span class="badge ${lhp.isActive ? 'bg-success' : 'bg-secondary'}">
                                ${lhp.isActive ? 'Hoạt động' : 'Không hoạt động'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
    `;

            globalState.currentScheduleId = maLich;

            // Đặt z-index cao và hiển thị modal
            const modalElement = document.getElementById('scheduleDetailModal');
            modalElement.style.zIndex = '1065';

            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static'
            });
            modal.show();

            // Đảm bảo modal luôn ở trên
            setTimeout(() => {
                modalElement.style.zIndex = '1065';
                const backdrop = document.querySelector('.modal-backdrop:last-child');
                if (backdrop) {
                    backdrop.style.zIndex = '1064';
                }
            }, 100);
        }

        function editFromDetail() {
            bootstrap.Modal.getInstance(document.getElementById('scheduleDetailModal')).hide();
            setTimeout(() => editSchedule(globalState.currentScheduleId), 300);
        }

        // ========================================
        // SEMESTER SCHEDULE MANAGEMENT
        // ========================================
        function openSemesterScheduleModal() {
            // Đóng tất cả modal khác trước
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const instance = bootstrap.Modal.getInstance(modal);
                if (instance) {
                    instance.hide();
                }
            });

            setTimeout(() => {
                const modal = new bootstrap.Modal(document.getElementById('semesterScheduleModal'), {
                    backdrop: 'static',
                    keyboard: false
                });

                modal.show();

                // Khởi tạo Select2 sau khi modal hiển thị
                setTimeout(() => {
                    safeSelect2Init('#semesterScheduleSelect, #yearScheduleSelect', {
                        theme: 'bootstrap-5',
                        width: '100%',
                        dropdownParent: $('#semesterScheduleModal')
                    });
                }, 200);

            }, 300);
        }

        // Helper function để xử lý Select2 an toàn
        function safeSelect2Destroy(selector) {
            $(selector).each(function() {
                if ($(this).hasClass('select2-hidden-accessible')) {
                    try {
                        $(this).select2('destroy');
                    } catch (error) {
                        console.warn('Error destroying Select2:', error);
                    }
                }
            });
        }

        function safeSelect2Init(selector, options) {
            // Destroy trước nếu có
            safeSelect2Destroy(selector);

            // Khởi tạo mới
            try {
                $(selector).select2(options);
            } catch (error) {
                console.warn('Error initializing Select2:', error);
            }
        }

        async function loadSemesterClasses() {
            const semester = document.getElementById('semesterScheduleSelect').value;
            const year = document.getElementById('yearScheduleSelect').value;

            if (!semester || !year) {
                showNotification('Vui lòng chọn học kỳ và năm học', 'warning');
                return;
            }

            try {
                showLoading(true);

                // Filter LHP by semester and year
                const semesterClasses = globalState.lopHocPhanData.filter(lhp =>
                    lhp.hocKy === semester && lhp.namHoc === year
                );

                if (semesterClasses.length === 0) {
                    showNotification('Không tìm thấy lớp học phần nào trong học kỳ này', 'info');
                    return;
                }

                // Show configuration section
                document.getElementById('scheduleConfiguration').style.display = 'block';

                // Update semester summary
                const semesterInfo = globalState.semesterData.find(s => s.maHocKy === semester);
                const yearInfo = globalState.yearData.find(y => y.maNamHoc === year);

                document.getElementById('semesterSummary').innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <strong>Học kỳ:</strong> ${semesterInfo ? semesterInfo.tenHocKy : semester}
                </div>
                <div class="col-md-4">
                    <strong>Năm học:</strong> ${yearInfo ? yearInfo.tenNamHoc : year}
                </div>
                <div class="col-md-4">
                    <strong>Số lớp HP:</strong> ${semesterClasses.length}
                </div>
            </div>
        `;

                // Populate classes table
                const tbody = document.getElementById('semesterClassesBody');
                tbody.innerHTML = semesterClasses.map(lhp => {
                    const existingSchedules = globalState.scheduleData.filter(s => s.maLhp === lhp.maLhp);
                    const hasSchedule = existingSchedules.length > 0;

                    // Tìm thông tin môn học
                    const monHoc = globalState.monHocData.find(m => m.maMh === lhp.maMh);
                    const tenMonHoc = monHoc ? monHoc.tenMh : 'N/A';

                    // Tìm thông tin giảng viên
                    const giangVien = globalState.giangVienData.find(g => g.maGv === lhp.maGv);
                    const tenGiangVien = giangVien ? giangVien.hoTen : 'Chưa phân công';

                    // Tính số tiết/tuần
                    const soTietTuan = (lhp.soTietLyThuyet || 0) + (lhp.soTietThucHanh || 0);

                    return `
                <tr>
                    <td>
                        <input type="checkbox" class="class-checkbox" value="${lhp.maLhp}" ${!hasSchedule ? 'checked' : ''}>
                    </td>
                    <td>${lhp.maLhp}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${tenMonHoc}</span>
                            <small class="text-muted">${lhp.maMh || 'N/A'}</small>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-medium">${tenGiangVien}</span>
                            <small class="text-muted">${lhp.maGv || 'N/A'}</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-info">${soTietTuan || 0} tiết</span>
                        <small class="d-block text-muted">
                            LT: ${lhp.soTietLyThuyet || 0} | TH: ${lhp.soTietThucHanh || 0}
                        </small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${lhp.soSinhVien || 0} SV</span>
                    </td>
                    <td>
                        ${hasSchedule ?
                        `<span class="badge bg-success">Đã có lịch (${existingSchedules.length})</span>` :
                        '<span class="badge bg-warning">Chưa có lịch</span>'
                    }
                    </td>
                    <td>
                        ${hasSchedule ?
                        `<button class="btn btn-sm btn-outline-primary" onclick="viewClassSchedule('${lhp.maLhp}')">
                                <i class="fas fa-eye me-1"></i>Xem lịch
                            </button>` :
                        `<button class="btn btn-sm btn-outline-success" onclick="createClassSchedule('${lhp.maLhp}')">
                                <i class="fas fa-plus me-1"></i>Tạo lịch
                            </button>`
                    }
                    </td>
                </tr>
            `;
                }).join('');

                // Enable buttons
                document.getElementById('previewBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('saveSemesterBtn').disabled = false;

            } catch (error) {
                console.error('Error loading semester classes:', error);
                showNotification('Lỗi khi tải lớp học phần: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function enrichLopHocPhanData() {
            // Load thêm dữ liệu đăng ký học nếu cần
            try {
                const dangKyResponse = await apiCall('/dangkyhoc');
                const dangKyData = Array.isArray(dangKyResponse) ? dangKyResponse : [];

                // Làm giàu dữ liệu LHP
                globalState.lopHocPhanData = globalState.lopHocPhanData.map(lhp => {
                    const monHoc = globalState.monHocData.find(m => m.maMh === lhp.maMh);
                    const giangVien = globalState.giangVienData.find(g => g.maGv === lhp.maGv);

                    // Tính số sinh viên đã đăng ký
                    const soSinhVien = dangKyData.filter(dk =>
                        dk.maLhp === lhp.maLhp && dk.isActive !== false
                    ).length;

                    // Tính số tiết lý thuyết và thực hành từ môn học
                    const soTietLyThuyet = monHoc ? (monHoc.soTietLyThuyet || 0) : (lhp.soTietLyThuyet || 0);
                    const soTietThucHanh = monHoc ? (monHoc.soTietThucHanh || 0) : (lhp.soTietThucHanh || 0);

                    return {
                        ...lhp,
                        tenMonHoc: monHoc ? monHoc.tenMh : lhp.tenMonHoc,
                        tenGiangVien: giangVien ? giangVien.hoTen : lhp.tenGiangVien,
                        soSinhVien: lhp.soSinhVien || soSinhVien,
                        soTietLyThuyet: soTietLyThuyet,
                        soTietThucHanh: soTietThucHanh
                    };
                });
            } catch (error) {
                console.warn('Không thể tải dữ liệu đăng ký học:', error);
                // Vẫn làm giàu dữ liệu với thông tin có sẵn
                globalState.lopHocPhanData = globalState.lopHocPhanData.map(lhp => {
                    const monHoc = globalState.monHocData.find(m => m.maMh === lhp.maMh);
                    const giangVien = globalState.giangVienData.find(g => g.maGv === lhp.maGv);

                    return {
                        ...lhp,
                        tenMonHoc: monHoc ? monHoc.tenMh : lhp.tenMonHoc,
                        tenGiangVien: giangVien ? giangVien.hoTen : lhp.tenGiangVien,
                        soSinhVien: lhp.soSinhVien || 0,
                        soTietLyThuyet: lhp.soTietLyThuyet || 0,
                        soTietThucHanh: lhp.soTietThucHanh || 0
                    };
                });
            }
        }


        function toggleSelectAllClasses() {
            const selectAll = document.getElementById('selectAllClasses');
            const checkboxes = document.querySelectorAll('.class-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        async function autoGenerateSchedule() {
            const selectedClasses = Array.from(document.querySelectorAll('.class-checkbox:checked')).map(cb => cb.value);

            if (selectedClasses.length === 0) {
                showNotification('Vui lòng chọn ít nhất một lớp học phần', 'warning');
                return;
            }

            const options = {
                avoidConflicts: document.getElementById('avoidConflicts').checked,
                optimizeRooms: document.getElementById('optimizeRooms').checked,
                balanceWorkload: document.getElementById('balanceWorkload').checked,
                preferMorning: document.getElementById('preferMorning').checked
            };

            try {
                showLoading(true);

                // Generate schedules for selected classes
                const generatedSchedules = [];

                for (const maLhp of selectedClasses) {
                    const lhp = globalState.lopHocPhanData.find(l => l.maLhp === maLhp);
                    if (!lhp) continue;

                    // Simple auto-scheduling logic
                    const schedule = await generateScheduleForClass(lhp, options);
                    if (schedule) {
                        generatedSchedules.push(schedule);
                    }
                }

                if (generatedSchedules.length > 0) {
                    showNotification(`Đã tạo lịch cho ${generatedSchedules.length}/${selectedClasses.length} lớp học phần`, 'success');

                    // Save generated schedules
                    const semester = document.getElementById('semesterScheduleSelect').value;
                    const result = await apiCall(`/lichhoc/semester/${semester}/create-all`, 'POST', generatedSchedules);

                    if (result.success !== false) {
                        showNotification('Lưu lịch học kỳ thành công!', 'success');
                        await loadScheduleData();
                        await refreshDisplay();
                        bootstrap.Modal.getInstance(document.getElementById('semesterScheduleModal')).hide();
                    } else {
                        showNotification('Có lỗi khi lưu một số lịch học: ' + (result.message || ''), 'warning');
                    }
                } else {
                    showNotification('Không thể tạo lịch cho các lớp học phần đã chọn', 'error');
                }

            } catch (error) {
                console.error('Error generating schedule:', error);
                showNotification('Lỗi khi tự động sắp lịch: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function generateScheduleForClass(lhp, options) {
            // Simple scheduling algorithm
            const availableRooms = globalState.phongHocData.filter(room => room.isActive !== false);
            const availableDays = [2, 3, 4, 5, 6]; // Monday to Friday
            const availableSlots = options.preferMorning ? [1, 2, 3, 4, 5, 6] : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

            const totalSessions = (lhp.soTietLyThuyet || 0) + (lhp.soTietThucHanh || 0);
            const sessionsPerWeek = Math.min(totalSessions, 4); // Max 4 sessions per week

            for (const day of availableDays) {
                for (const startSlot of availableSlots) {
                    if (startSlot + sessionsPerWeek - 1 > 12) continue; // Don't exceed daily slots

                    for (const room of availableRooms) {
                        // Check if this slot is available
                        const isAvailable = !globalState.scheduleData.some(existing =>
                            existing.thu === day &&
                            existing.maPhong === room.maPhong &&
                            isTimeOverlap(startSlot, sessionsPerWeek, existing.tietBatDau, existing.soTiet)
                        );

                        // Check teacher availability
                        const teacherAvailable = !globalState.scheduleData.some(existing =>
                            existing.thu === day &&
                            existing.maGv === lhp.maGv &&
                            isTimeOverlap(startSlot, sessionsPerWeek, existing.tietBatDau, existing.soTiet)
                        );

                        if (isAvailable && teacherAvailable) {
                            return {
                                maLich: `LH${Date.now()}${Math.random().toString(36).substring(2, 5).toUpperCase()}`,
                                maLhp: lhp.maLhp,
                                thu: day,
                                tietBatDau: startSlot,
                                soTiet: sessionsPerWeek,
                                maPhong: room.maPhong,
                                isActive: true
                            };
                        }
                    }
                }
            }

            return null; // No available slot found
        }

        // ========================================
        // BULK OPERATIONS
        // ========================================
        function toggleScheduleSelection(maLich) {
            if (globalState.selectedSchedules.has(maLich)) {
                globalState.selectedSchedules.delete(maLich);
            } else {
                globalState.selectedSchedules.add(maLich);
            }

            updateSelectionUI();
            updateSelectionInfo();
        }

        function selectAllSchedules() {
            globalState.filteredData.forEach(schedule => {
                globalState.selectedSchedules.add(schedule.maLich);
            });
            updateSelectionUI();
            updateSelectionInfo();
        }

        function clearSelection() {
            globalState.selectedSchedules.clear();
            updateSelectionUI();
            updateSelectionInfo();
        }

        function updateSelectionUI() {
            // Update checkboxes
            document.querySelectorAll('.schedule-checkbox').forEach(checkbox => {
                checkbox.checked = globalState.selectedSchedules.has(checkbox.value);
            });

            // Update select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                const visibleSchedules = globalState.filteredData.map(s => s.maLich);
                const selectedVisible = visibleSchedules.filter(id => globalState.selectedSchedules.has(id));

                selectAllCheckbox.checked = visibleSchedules.length > 0 && selectedVisible.length === visibleSchedules.length;
                selectAllCheckbox.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visibleSchedules.length;
            }

            // Update calendar view
            if (globalState.currentViewMode === 'calendar') {
                document.querySelectorAll('.schedule-item').forEach(item => {
                    const scheduleId = item.getAttribute('data-schedule-id');
                    if (globalState.selectedSchedules.has(scheduleId)) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            // Update list view
            if (globalState.currentViewMode === 'list') {
                document.querySelectorAll('.schedule-row').forEach(row => {
                    const checkbox = row.querySelector('.schedule-checkbox');
                    if (checkbox && globalState.selectedSchedules.has(checkbox.value)) {
                        row.classList.add('table-primary');
                    } else {
                        row.classList.remove('table-primary');
                    }
                });
            }
        }

        function updateSelectionInfo() {
            const selectedCount = globalState.selectedSchedules.size;

            // Update bulk action buttons
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const moveBtn = document.getElementById('moveSelectedBtn');

            if (deleteBtn) deleteBtn.disabled = selectedCount === 0;
            if (moveBtn) moveBtn.disabled = selectedCount === 0;

            // Update selected count in move modal
            const selectedCountSpan = document.getElementById('selectedCount');
            if (selectedCountSpan) selectedCountSpan.textContent = selectedCount;
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const visibleSchedules = globalState.filteredData.map(s => s.maLich);

            if (selectAllCheckbox.checked) {
                visibleSchedules.forEach(id => globalState.selectedSchedules.add(id));
            } else {
                visibleSchedules.forEach(id => globalState.selectedSchedules.delete(id));
            }

            updateSelectionUI();
            updateSelectionInfo();
        }

        function handleRowClick(event, maLich) {
            if (event.ctrlKey || event.metaKey) {
                toggleScheduleSelection(maLich);
            } else {
                showScheduleDetail(maLich);
            }
        }

        async function deleteSelectedSchedules() {
            const selectedCount = globalState.selectedSchedules.size;
            if (selectedCount === 0) return;

            if (!confirm(`Bạn có chắc chắn muốn xóa ${selectedCount} lịch học đã chọn?`)) return;

            try {
                showLoading(true);
                const deletePromises = Array.from(globalState.selectedSchedules).map(maLich =>
                    apiCall(`/lichhoc/${maLich}`, 'DELETE')
                );

                await Promise.all(deletePromises);

                showNotification(`Đã xóa ${selectedCount} lịch học thành công!`, 'success');
                globalState.selectedSchedules.clear();
                await loadScheduleData();
                await refreshDisplay();

            } catch (error) {
                console.error('Error deleting schedules:', error);
                showNotification('Lỗi khi xóa lịch học: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function moveSelectedSchedules() {
            const selectedCount = globalState.selectedSchedules.size;
            if (selectedCount === 0) return;

            document.getElementById('selectedCount').textContent = selectedCount;
            const modal = new bootstrap.Modal(document.getElementById('moveRoomModal'));
            modal.show();
        }

        async function checkMoveConflicts() {
            const newRoom = document.getElementById('newRoom').value;
            if (!newRoom) {
                showNotification('Vui lòng chọn phòng học mới', 'warning');
                return;
            }

            try {
                const conflicts = [];

                for (const maLich of globalState.selectedSchedules) {
                    const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
                    if (!schedule)  continue;

                    // Check if new room has conflicts
                    const roomConflicts = globalState.scheduleData.filter(other =>
                        other.maLich !== schedule.maLich &&
                        other.maPhong === newRoom &&
                        other.thu === schedule.thu &&
                        isTimeOverlap(schedule.tietBatDau, schedule.soTiet, other.tietBatDau, other.soTiet)
                    );

                    if (roomConflicts.length > 0) {
                        conflicts.push({
                            schedule: schedule,
                            conflicts: roomConflicts
                        });
                    }
                }

                const warningDiv = document.getElementById('moveConflictWarning');
                const detailsDiv = document.getElementById('moveConflictDetails');

                if (conflicts.length > 0) {
                    let detailsHtml = `<strong>Phát hiện ${conflicts.length} lịch học sẽ bị trùng:</strong><ul>`;
                    conflicts.forEach(conflict => {
                        detailsHtml += `<li>${conflict.schedule.tenMonHoc} (${conflict.schedule.maLich}) - ${getDayName(conflict.schedule.thu)} tiết ${conflict.schedule.tietBatDau}</li>`;
                    });
                    detailsHtml += '</ul>';

                    detailsDiv.innerHTML = detailsHtml;
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                    showNotification('Không có trùng lịch với phòng mới!', 'success');
                }

            } catch (error) {
                console.error('Error checking move conflicts:', error);
                showNotification('Lỗi khi kiểm tra trùng lịch: ' + error.message, 'error');
            }
        }

        async function confirmMoveRooms() {
            const newRoom = document.getElementById('newRoom').value;
            if (!newRoom) {
                showNotification('Vui lòng chọn phòng học mới', 'warning');
                return;
            }

            const selectedCount = globalState.selectedSchedules.size;
            if (!confirm(`Bạn có chắc chắn muốn chuyển ${selectedCount} lịch học sang phòng ${newRoom}?`)) return;

            try {
                showLoading(true);

                // Validate và clean data trước khi gửi
                const validScheduleIds = [];
                const invalidSchedules = [];

                for (const maLich of globalState.selectedSchedules) {
                    const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
                    if (schedule) {
                        // Validate dữ liệu
                        const soTiet = parseInt(schedule.soTiet);
                        const tietBatDau = parseInt(schedule.tietBatDau);
                        const thu = parseInt(schedule.thu);

                        if (isNaN(soTiet) || soTiet < 1 || soTiet > 6) {
                            invalidSchedules.push(`${maLich}: Số tiết không hợp lệ (${schedule.soTiet})`);
                            continue;
                        }

                        if (isNaN(tietBatDau) || tietBatDau < 1 || tietBatDau > 12) {
                            invalidSchedules.push(`${maLich}: Tiết bắt đầu không hợp lệ (${schedule.tietBatDau})`);
                            continue;
                        }

                        if (isNaN(thu) || thu < 2 || thu > 8) {
                            invalidSchedules.push(`${maLich}: Thứ không hợp lệ (${schedule.thu})`);
                            continue;
                        }

                        validScheduleIds.push(maLich);
                    } else {
                        invalidSchedules.push(`${maLich}: Không tìm thấy lịch học`);
                    }
                }

                // Hiển thị lỗi validation nếu có
                if (invalidSchedules.length > 0) {
                    showNotification(`Có ${invalidSchedules.length} lịch học không hợp lệ:\n${invalidSchedules.join('\n')}`, 'error');

                    // Hỏi có muốn tiếp tục với những lịch hợp lệ không
                    if (validScheduleIds.length > 0) {
                        if (!confirm(`Có ${validScheduleIds.length} lịch học hợp lệ. Bạn có muốn tiếp tục chuyển phòng cho những lịch này không?`)) {
                            return;
                        }
                    } else {
                        showNotification('Không có lịch học hợp lệ nào để chuyển phòng', 'error');
                        return;
                    }
                }

                if (validScheduleIds.length === 0) {
                    showNotification('Không có lịch học hợp lệ nào để chuyển phòng', 'error');
                    return;
                }

                const requestData = {
                    scheduleIds: validScheduleIds,
                    newRoomId: newRoom
                };

                const response = await apiCall('/lichhoc/move-room', 'PUT', requestData);

                if (response.success) {
                    showNotification(response.message, 'success');
                } else {
                    showNotification(response.message, 'warning');
                    if (response.errors && response.errors.length > 0) {
                        console.warn('Move errors:', response.errors);

                        // Hiển thị chi tiết lỗi
                        const errorDetails = response.errors.join('\n');
                        setTimeout(() => {
                            showNotification(`Chi tiết lỗi:\n${errorDetails}`, 'error');
                        }, 1000);
                    }
                }

                globalState.selectedSchedules.clear();
                bootstrap.Modal.getInstance(document.getElementById('moveRoomModal')).hide();
                await loadScheduleData();
                await refreshDisplay();

            } catch (error) {
                console.error('Error moving schedules:', error);
                showNotification('Lỗi khi chuyển phòng: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        function debugScheduleData() {
            console.log('=== DEBUG SCHEDULE DATA ===');

            for (const maLich of globalState.selectedSchedules) {
                const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
                if (schedule) {
                    console.log(`Schedule ${maLich}:`, {
                        soTiet: schedule.soTiet,
                        tietBatDau: schedule.tietBatDau,
                        thu: schedule.thu,
                        maPhong: schedule.maPhong,
                        isActive: schedule.isActive
                    });

                    // Check validation
                    const issues = [];
                    if (!schedule.soTiet || schedule.soTiet < 1 || schedule.soTiet > 6) {
                        issues.push(`soTiet invalid: ${schedule.soTiet}`);
                    }
                    if (!schedule.tietBatDau || schedule.tietBatDau < 1 || schedule.tietBatDau > 12) {
                        issues.push(`tietBatDau invalid: ${schedule.tietBatDau}`);
                    }
                    if (!schedule.thu || schedule.thu < 2 || schedule.thu > 8) {
                        issues.push(`thu invalid: ${schedule.thu}`);
                    }

                    if (issues.length > 0) {
                        console.warn(`Issues with ${maLich}:`, issues);
                    }
                }
            }

            console.log('=== END DEBUG ===');
        }

        // Gọi function này trước khi chuyển phòng để debug
        // debugScheduleData();

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function getDayName(dayNumber) {
            const days = {
                2: 'Thứ 2',
                3: 'Thứ 3',
                4: 'Thứ 4',
                5: 'Thứ 5',
                6: 'Thứ 6',
                7: 'Thứ 7',
                8: 'Chủ nhật'
            };
            return days[dayNumber] || 'N/A';
        }

        function groupSchedulesByTeacher(schedules) {
            // Group schedules by teacher for better visualization
            const grouped = {};
            schedules.forEach(schedule => {
                const key = `${schedule.maGv}_${schedule.thu}_${schedule.tietBatDau}`;
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(schedule);
            });

            // Return flattened array with grouped schedules having adjusted positions
            const result = [];
            Object.values(grouped).forEach(group => {
                group.forEach((schedule, index) => {
                    result.push({
                        ...schedule,
                        groupIndex: index,
                        groupSize: group.length
                    });
                });
            });

            return result;
        }

        function updateStatistics() {
            // Calculate statistics
            const totalSchedules = globalState.scheduleData.length;
            const activeSchedules = globalState.scheduleData.filter(s => s.isActive !== false).length;
            const uniqueTeachers = new Set(globalState.scheduleData.map(s => s.maGv)).size;
            const uniqueRooms = new Set(globalState.scheduleData.map(s => s.maPhong)).size;

            let conflictCount = 0;
            globalState.scheduleData.forEach(schedule => {
                if (checkScheduleConflicts(schedule).length > 0) {
                    conflictCount++;
                }
            });

            // Update DOM
            document.getElementById('totalSchedules').textContent = totalSchedules;
            document.getElementById('activeTeachers').textContent = uniqueTeachers;
            document.getElementById('usedRooms').textContent = uniqueRooms;
            document.getElementById('conflicts').textContent = conflictCount;

            // Update change indicators (simplified)
            document.getElementById('scheduleChange').textContent = `${activeSchedules} hoạt động`;
            document.getElementById('teacherChange').textContent = `${uniqueTeachers} giảng viên`;
            document.getElementById('roomChange').textContent = `${uniqueRooms} phòng`;
            document.getElementById('conflictChange').textContent = conflictCount > 0 ? `${conflictCount} trùng lịch` : 'Không có';
        }

        function showCurrentSemesterInfo() {
            const semesterInfo = document.getElementById('semesterInfo');
            const semesterDetails = document.getElementById('semesterDetails');

            if (globalState.currentSemester || globalState.currentYear) {
                const semesterName = globalState.semesterData.find(s => s.maHocKy === globalState.currentSemester)?.tenHocKy || globalState.currentSemester;
                const yearName = globalState.yearData.find(y => y.maNamHoc === globalState.currentYear)?.tenNamHoc || globalState.currentYear;

                semesterDetails.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Học kỳ:</strong> ${semesterName || 'Tất cả'}
                        </div>
                        <div class="col-md-4">
                            <strong>Năm học:</strong> ${yearName || 'Tất cả'}
                        </div>
                        <div class="col-md-4">
                            <strong>Số lịch học:</strong> ${globalState.filteredData.length}
                        </div>
                    </div>
                `;
                semesterInfo.style.display = 'block';
            } else {
                semesterInfo.style.display = 'none';
            }
        }

        // ========================================
        // API AND UTILITY FUNCTIONS
        // ========================================
        async function apiCall(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE}${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            } else {
                return await response.text();
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('d-none', !show);
            }
            globalState.isLoading = show;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';

            notification.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="${icon} me-2 mt-1"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close btn-close-sm ms-2" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;

            container.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function setupAutoRefresh() {
            // Refresh data every 5 minutes
            globalState.refreshInterval = setInterval(async () => {
                if (!globalState.isLoading && globalState.isInitialized) {
                    console.log('🔄 Auto-refreshing data...');
                    await loadScheduleData();
                    await refreshDisplay();
                }
            }, 5 * 60 * 1000);
        }

        // ========================================
        // EXPORT FUNCTIONS
        // ========================================
        async function refreshData() {
            showLoading(true);
            try {
                await loadScheduleData();
                await refreshDisplay();
                showNotification('Dữ liệu đã được làm mới!', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Lỗi khi làm mới dữ liệu: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportSchedule() {
            try {
                showLoading(true);

                // Prepare filters
                const filters = {
                    semester: globalState.currentSemester,
                    year: globalState.currentYear,
                    teacher: document.getElementById('filterGiangVien').value,
                    room: document.getElementById('filterPhongHoc').value,
                    subject: document.getElementById('filterMonHoc').value
                };

                // Create URL with query parameters
                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value) params.append(key, value);
                });

                const response = await fetch(`${API_BASE}/lichhoc/export?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Get filename from response headers or create default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'lich-hoc.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }

                // Create download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Xuất lịch học thành công!', 'success');

            } catch (error) {
                console.error('Error exporting schedule:', error);
                showNotification('Lỗi khi xuất lịch học: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportToExcel() {
            await exportSchedule();
        }

        // ========================================
        // CALENDAR NAVIGATION
        // ========================================
        let calendarState = {
            currentWeekStart: new Date(),
            viewMode: 'week', // 'week', 'month', 'semester'
            selectedDate: new Date()
        };

        function initializeCalendarState() {
            // Set to start of current week (Monday)
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Handle Sunday
            calendarState.currentWeekStart = new Date(today);
            calendarState.currentWeekStart.setDate(today.getDate() + mondayOffset);
            calendarState.selectedDate = new Date(today);

            updateWeekDisplay();
        }

        function updateWeekDisplay() {
            const weekStart = new Date(calendarState.currentWeekStart);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const formatDate = (date) => {
                return date.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            document.getElementById('weekDateRange').textContent =
                `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;

            // Update day headers with dates
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + i);
                const dayNumber = i + 2 > 7 ? 8 : i + 2; // Map to our day numbering (2-8)

                const dayHeader = document.querySelector(`[data-day="${dayNumber}"] .day-header`);
                if (dayHeader) {
                    const dayName = getDayName(dayNumber);
                    const dateStr = dayDate.getDate().toString().padStart(2, '0');
                    const isToday = dayDate.toDateString() === new Date().toDateString();

                    dayHeader.innerHTML = `
                    <div>${dayName}</div>
                    <div class="day-date ${isToday ? 'today' : ''}">${dateStr}</div>
                `;
                }
            }
        }

        function previousWeek() {
            calendarState.currentWeekStart.setDate(calendarState.currentWeekStart.getDate() - 7);
            updateWeekDisplay();
            renderCurrentView();
            showNotification('Đã chuyển sang tuần trước', 'info');
        }

        function currentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            calendarState.currentWeekStart = new Date(today);
            calendarState.currentWeekStart.setDate(today.getDate() + mondayOffset);

            updateWeekDisplay();
            renderCurrentView();
            showNotification('Đã chuyển về tuần hiện tại', 'success');
        }

        function nextWeek() {
            calendarState.currentWeekStart.setDate(calendarState.currentWeekStart.getDate() + 7);
            updateWeekDisplay();
            renderCurrentView();
            showNotification('Đã chuyển sang tuần sau', 'info');
        }

        function showWeekView() {
            calendarState.viewMode = 'week';
            document.querySelector('.calendar-controls .btn-group .active').classList.remove('active');
            event.target.classList.add('active');

            document.getElementById('currentWeekTitle').textContent = 'Lịch học tuần';
            updateWeekDisplay();
            renderCurrentView();
        }

        function showMonthView() {
            calendarState.viewMode = 'month';
            document.querySelector('.calendar-controls .btn-group .active').classList.remove('active');
            event.target.classList.add('active');

            document.getElementById('currentWeekTitle').textContent = 'Lịch học tháng';
            showMonthCalendar();
        }

        function showSemesterView() {
            calendarState.viewMode = 'semester';
            document.querySelector('.calendar-controls .btn-group .active').classList.remove('active');
            event.target.classList.add('active');

            document.getElementById('currentWeekTitle').textContent = 'Lịch học học kỳ';
            showSemesterCalendar();
        }

        function showMonthCalendar() {
            // Clear current view
            for (let day = 2; day <= 8; day++) {
                const dayContent = document.getElementById(`day-${day}`);
                if (dayContent) {
                    dayContent.innerHTML = '';
                }
            }

            // Get current month schedules
            const currentMonth = calendarState.selectedDate.getMonth();
            const currentYear = calendarState.selectedDate.getFullYear();

            const monthSchedules = globalState.filteredData.filter(schedule => {
                // For month view, show all schedules (since we don't have specific dates)
                // In a real implementation, you'd filter by actual schedule dates
                return true;
            });

            // Render schedules for the month
            monthSchedules.forEach(schedule => {
                renderScheduleItem(schedule);
            });

            showNotification(`Hiển thị lịch học tháng ${currentMonth + 1}/${currentYear}`, 'info');
        }

        function showSemesterCalendar() {
            // Clear current view
            for (let day = 2; day <= 8; day++) {
                const dayContent = document.getElementById(`day-${day}`);
                if (dayContent) {
                    dayContent.innerHTML = '';
                }
            }

            // Show all schedules for current semester
            const semesterSchedules = globalState.filteredData.filter(schedule => {
                if (globalState.currentSemester && globalState.currentYear) {
                    return schedule.hocKy === globalState.currentSemester &&
                        schedule.namHoc === globalState.currentYear;
                }
                return true;
            });

            // Group schedules by week pattern and render
            semesterSchedules.forEach(schedule => {
                renderScheduleItem(schedule);
            });

            const semesterName = globalState.currentSemester || 'Tất cả';
            const yearName = globalState.currentYear || 'Tất cả';
            showNotification(`Hiển thị lịch học ${semesterName} - ${yearName}`, 'info');
        }

        // Add this function before the existing global function declarations
        function duplicateSchedule(maLich) {
            const schedule = globalState.scheduleData.find(s => s.maLich === maLich);
            if (!schedule) {
                showNotification('Không tìm thấy lịch học để nhân bản', 'error');
                return;
            }

            // Close detail modal first
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('scheduleDetailModal'));
            if (detailModal) {
                detailModal.hide();
            }

            setTimeout(() => {
                // Open create modal with duplicated data
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-copy me-2"></i>Nhân bản lịch học';
                document.getElementById('scheduleForm').reset();
                document.getElementById('scheduleId').value = '';
                globalState.currentScheduleId = null;

                // Generate new ID
                generateScheduleId();

                // Fill form with original data
                document.getElementById('maLhp').value = schedule.maLhp;
                document.getElementById('thu').value = schedule.thu;
                document.getElementById('tietBatDau').value = schedule.tietBatDau;
                document.getElementById('soTiet').value = schedule.soTiet;
                document.getElementById('maPhong').value = schedule.maPhong;

                // Calculate end time
                calculateEndTime();

                // Show warning about potential conflicts
                showNotification('Đang nhân bản lịch học. Vui lòng kiểm tra trùng lịch trước khi lưu!', 'warning');

                const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
                modal.show();
            }, 300);
        }

        // ========================================
        // ADDITIONAL HELPER FUNCTIONS
        // ========================================
        function suggestAlternativeRooms() {
            const thu = document.getElementById('thu').value;
            const tietBatDau = parseInt(document.getElementById('tietBatDau').value);
            const soTiet = parseInt(document.getElementById('soTiet').value);

            if (!thu || !tietBatDau || !soTiet) {
                showNotification('Vui lòng điền đầy đủ thông tin thời gian trước', 'warning');
                return;
            }

            const availableRooms = globalState.phongHocData.filter(room => {
                // Check if room is available at this time
                const isAvailable = !globalState.scheduleData.some(schedule =>
                    schedule.maPhong === room.maPhong &&
                    schedule.thu.toString() === thu &&
                    isTimeOverlap(tietBatDau, soTiet, schedule.tietBatDau, schedule.soTiet) &&
                    schedule.isActive !== false
                );
                return isAvailable && room.isActive !== false;
            });

            if (availableRooms.length === 0) {
                showNotification('Không có phòng học nào trống trong thời gian này', 'warning');
            } else {
                const roomList = availableRooms.slice(0, 5).map(room =>
                    `${room.tenPhong} (${room.maPhong}) - ${room.loaiPhong || 'Phòng học'}`
                ).join('\n');

                alert(`Gợi ý ${availableRooms.length} phòng học trống:\n\n${roomList}${availableRooms.length > 5 ? '\n\n... và ' + (availableRooms.length - 5) + ' phòng khác' : ''}`);
            }
        }

        function manageSemesterSchedule() {
            openSemesterScheduleModal();

            // Pre-select current semester and year
            if (globalState.currentSemester) {
                document.getElementById('semesterScheduleSelect').value = globalState.currentSemester;
            }
            if (globalState.currentYear) {
                document.getElementById('yearScheduleSelect').value = globalState.currentYear;
            }
        }

        function viewClassSchedule(maLhp) {
            // Filter to show only schedules for this class
            document.getElementById('searchInput').value = maLhp;
            filterData();

            // Close modal and switch to list view
            bootstrap.Modal.getInstance(document.getElementById('semesterScheduleModal')).hide();

            setTimeout(() => {
                document.getElementById('listView').checked = true;
                globalState.currentViewMode = 'list';
                toggleView();
            }, 300);
        }

        function createClassSchedule(maLhp) {
            // Close semester modal and open create modal
            bootstrap.Modal.getInstance(document.getElementById('semesterScheduleModal')).hide();

            setTimeout(() => {
                openCreateModal();
                document.getElementById('maLhp').value = maLhp;
            }, 300);
        }

        function previewSchedule() {
            showNotification('Chức năng xem trước đang được phát triển', 'info');
        }

        function saveSemesterSchedule() {
            showNotification('Chức năng lưu lịch học kỳ đang được phát triển', 'info');
        }

        function showScheduleContextMenu(event, schedule) {
            // Context menu implementation
            event.preventDefault();

            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.position = 'fixed';
            contextMenu.style.left = event.clientX + 'px';
            contextMenu.style.top = event.clientY + 'px';
            contextMenu.style.background = 'white';
            contextMenu.style.border = '1px solid #ccc';
            contextMenu.style.borderRadius = '5px';
            contextMenu.style.padding = '5px 0';
            contextMenu.style.zIndex = '10000';
            contextMenu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';

            contextMenu.innerHTML = `
                <div class="context-menu-item" onclick="showScheduleDetail('${schedule.maLich}')">
                    <i class="fas fa-eye me-2"></i>Xem chi tiết
                </div>
                <div class="context-menu-item" onclick="editSchedule('${schedule.maLich}')">
                    <i class="fas fa-edit me-2"></i>Chỉnh sửa
                </div>
                <div class="context-menu-item" onclick="duplicateSchedule('${schedule.maLich}')">
                    <i class="fas fa-copy me-2"></i>Nhân bản
                </div>
                <hr class="my-1">
                <div class="context-menu-item text-danger" onclick="deleteSchedule('${schedule.maLich}')">
                    <i class="fas fa-trash me-2"></i>Xóa
                </div>
            `;

            // Add styles for menu items
            const style = document.createElement('style');
            style.textContent = `
                .context-menu-item {
                    padding: 8px 15px;
                    cursor: pointer;
                    font-size: 14px;
                }
                .context-menu-item:hover {
                    background-color: #f8f9fa;
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(contextMenu);

            // Remove menu when clicking elsewhere
            const removeMenu = () => {
                if (contextMenu.parentElement) {
                    contextMenu.remove();
                    document.removeEventListener('click', removeMenu);
                }
            };

            setTimeout(() => {
                document.addEventListener('click', removeMenu);
            }, 100);
        }

        // Make functions globally available
        window.openCreateModal = openCreateModal;
        window.editSchedule = editSchedule;
        window.deleteSchedule = deleteSchedule;
        window.saveSchedule = saveSchedule;
        window.showScheduleDetail = showScheduleDetail;
        window.editFromDetail = editFromDetail;
        window.duplicateSchedule = duplicateSchedule;
        window.checkConflictsBeforeSave = checkConflictsBeforeSave;
        window.suggestAlternativeRooms = suggestAlternativeRooms;
        window.openSemesterScheduleModal = openSemesterScheduleModal;
        window.loadSemesterClasses = loadSemesterClasses;
        window.toggleSelectAllClasses = toggleSelectAllClasses;
        window.autoGenerateSchedule = autoGenerateSchedule;
        window.previewSchedule = previewSchedule;
        window.saveSemesterSchedule = saveSemesterSchedule;
        window.viewClassSchedule = viewClassSchedule;
        window.createClassSchedule = createClassSchedule;
        window.manageSemesterSchedule = manageSemesterSchedule;
        window.loadCurrentSemester = loadCurrentSemester;
        window.selectAllSchedules = selectAllSchedules;
        window.clearSelection = clearSelection;
        window.deleteSelectedSchedules = deleteSelectedSchedules;
        window.moveSelectedSchedules = moveSelectedSchedules;
        window.checkMoveConflicts = checkMoveConflicts;
        window.confirmMoveRooms = confirmMoveRooms;
        window.toggleSelectAll = toggleSelectAll;
        window.toggleScheduleSelection = toggleScheduleSelection;
        window.handleRowClick = handleRowClick;
        window.changePage = changePage;
        window.refreshData = refreshData;
        window.exportSchedule = exportSchedule;
        window.exportToExcel = exportToExcel;
        window.checkAllConflicts = checkAllConflicts;
        window.previousWeek = previousWeek;
        window.currentWeek = currentWeek;
        window.nextWeek = nextWeek;
        window.showWeekView = showWeekView;
        window.showMonthView = showMonthView;
        window.showSemesterView = showSemesterView;
        window.initializeCalendarState = initializeCalendarState;
    </script>
    </body>
    </html>
